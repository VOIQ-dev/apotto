var G=Object.defineProperty;var J=(e,o,t)=>o in e?G(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t;var $=(e,o,t)=>J(e,typeof o!="symbol"?o+"":o,t);const B=(e,o)=>o.some(t=>e instanceof t);let U,F;function K(){return U||(U=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return F||(F=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const I=new WeakMap,b=new WeakMap,y=new WeakMap;function W(e){const o=new Promise((t,n)=>{const s=()=>{e.removeEventListener("success",a),e.removeEventListener("error",r)},a=()=>{t(f(e.result)),s()},r=()=>{n(e.error),s()};e.addEventListener("success",a),e.addEventListener("error",r)});return y.set(o,e),o}function Q(e){if(I.has(e))return;const o=new Promise((t,n)=>{const s=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",r),e.removeEventListener("abort",r)},a=()=>{t(),s()},r=()=>{n(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",a),e.addEventListener("error",r),e.addEventListener("abort",r)});I.set(e,o)}let S={get(e,o,t){if(e instanceof IDBTransaction){if(o==="done")return I.get(e);if(o==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return f(e[o])},set(e,o,t){return e[o]=t,!0},has(e,o){return e instanceof IDBTransaction&&(o==="done"||o==="store")?!0:o in e}};function _(e){S=e(S)}function H(e){return V().includes(e)?function(...o){return e.apply(T(this),o),f(this.request)}:function(...o){return f(e.apply(T(this),o))}}function X(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&Q(e),B(e,K())?new Proxy(e,S):e)}function f(e){if(e instanceof IDBRequest)return W(e);if(b.has(e))return b.get(e);const o=X(e);return o!==e&&(b.set(e,o),y.set(o,e)),o}const T=e=>y.get(e);function Y(e,o,{blocked:t,upgrade:n,blocking:s,terminated:a}={}){const r=indexedDB.open(e,o),i=f(r);return n&&r.addEventListener("upgradeneeded",c=>{n(f(r.result),c.oldVersion,c.newVersion,f(r.transaction),c)}),t&&r.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),i.then(c=>{a&&c.addEventListener("close",()=>a()),s&&c.addEventListener("versionchange",l=>s(l.oldVersion,l.newVersion,l))}).catch(()=>{}),i}const z=["get","getKey","getAll","getAllKeys","count"],Z=["put","add","delete","clear"],w=new Map;function N(e,o){if(!(e instanceof IDBDatabase&&!(o in e)&&typeof o=="string"))return;if(w.get(o))return w.get(o);const t=o.replace(/FromIndex$/,""),n=o!==t,s=Z.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||z.includes(t)))return;const a=async function(r,...i){const c=this.transaction(r,s?"readwrite":"readonly");let l=c.store;return n&&(l=l.index(i.shift())),(await Promise.all([l[t](...i),s&&c.done]))[0]};return w.set(o,a),a}_(e=>({...e,get:(o,t,n)=>N(o,t)||e.get(o,t,n),has:(o,t)=>!!N(o,t)||e.has(o,t)}));const ee=["continue","continuePrimaryKey","advance"],M={},A=new WeakMap,j=new WeakMap,te={get(e,o){if(!ee.includes(o))return e[o];let t=M[o];return t||(t=M[o]=function(...n){A.set(this,j.get(this)[o](...n))}),t}};async function*oe(...e){let o=this;if(o instanceof IDBCursor||(o=await o.openCursor(...e)),!o)return;o=o;const t=new Proxy(o,te);for(j.set(t,o),y.set(t,T(o));o;)yield t,o=await(A.get(t)||o.continue()),A.delete(t)}function R(e,o){return o===Symbol.asyncIterator&&B(e,[IDBIndex,IDBObjectStore,IDBCursor])||o==="iterate"&&B(e,[IDBIndex,IDBObjectStore])}_(e=>({...e,get(o,t,n){return R(o,t)?oe:e.get(o,t,n)},has(o,t){return R(o,t)||e.has(o,t)}}));const ne="apotto-queue",se=1;class ae{constructor(){$(this,"db",null)}async getDB(){return this.db?this.db:(this.db=await Y(ne,se,{upgrade(o){if(!o.objectStoreNames.contains("queue")){const t=o.createObjectStore("queue",{keyPath:"id"});t.createIndex("by-status","status"),t.createIndex("by-createdAt","createdAt")}o.objectStoreNames.contains("settings")||o.createObjectStore("settings",{keyPath:"key"})}}),this.db)}async addItem(o){const t=await this.getDB(),n={...o,id:crypto.randomUUID(),status:"pending",createdAt:new Date().toISOString(),retryCount:0};return await t.put("queue",n),n}async getItem(o){return(await this.getDB()).get("queue",o)}async getAllItems(){return(await this.getDB()).getAll("queue")}async getItemsByStatus(o){return(await this.getDB()).getAllFromIndex("queue","by-status",o)}async getNextPendingItem(){const t=await(await this.getDB()).getAllFromIndex("queue","by-status","pending");return t.sort((n,s)=>new Date(n.createdAt).getTime()-new Date(s.createdAt).getTime()),t[0]}async getAndLockNextPendingItem(){const t=(await this.getDB()).transaction("queue","readwrite"),n=t.objectStore("queue"),a=await n.index("by-status").getAll("pending");if(a.length===0){await t.done;return}a.sort((i,c)=>new Date(i.createdAt).getTime()-new Date(c.createdAt).getTime());const r=a[0];return r.status="processing",await n.put(r),await t.done,r}async getProcessingItem(){return(await(await this.getDB()).getAllFromIndex("queue","by-status","processing"))[0]}async updateItemStatus(o,t,n){const s=await this.getDB(),a=await s.get("queue",o);if(!a)return;const r={...a,status:t,...n};t==="failed"&&(r.retryCount=(a.retryCount||0)+1),await s.put("queue",r)}async deleteItem(o){await(await this.getDB()).delete("queue",o)}async clearAll(){await(await this.getDB()).clear("queue")}async clearCompleted(){const o=await this.getDB(),t=await o.getAllFromIndex("queue","by-status","completed"),n=o.transaction("queue","readwrite");await Promise.all([...t.map(s=>n.store.delete(s.id)),n.done])}async isPaused(){const t=await(await this.getDB()).get("settings","isPaused");return(t==null?void 0:t.value)===!0}async pauseProcessing(){await(await this.getDB()).put("settings",{key:"isPaused",value:!0})}async resumeProcessing(){await(await this.getDB()).put("settings",{key:"isPaused",value:!1})}async getStats(){const t=await(await this.getDB()).getAll("queue");return{pending:t.filter(n=>n.status==="pending").length,processing:t.filter(n=>n.status==="processing").length,completed:t.filter(n=>n.status==="completed").length,failed:t.filter(n=>n.status==="failed").length,total:t.length}}}const m=new ae,p=[],re=200;function ce(e,o){const t=new Date().toISOString();p.push({timestamp:t,message:e,tabId:o}),p.length>re&&p.shift(),console.log(`[Content→BG] ${e}`)}console.log("[Background] Service Worker initialized (enhanced version with logging)");chrome.alarms.create("keepAlive",{periodInMinutes:.5});chrome.alarms.create("processQueue",{periodInMinutes:.1});chrome.alarms.onAlarm.addListener(async e=>{e.name==="keepAlive"&&console.log("[Background] Keep alive ping"),e.name==="processQueue"&&await E()});chrome.runtime.onMessage.addListener((e,o,t)=>(console.log("[Background] Message received:",e.type),(async()=>{var n;try{switch(e.type){case"ADD_TO_QUEUE":await m.addItem(e.payload),t({success:!0});break;case"GET_QUEUE_STATUS":const s=await m.getAllItems();t({success:!0,data:s});break;case"CLEAR_QUEUE":await m.clearAll(),t({success:!0});break;case"CLEAR_COMPLETED_AND_FAILED":const a=await m.getAllItems();for(const r of a)(r.status==="completed"||r.status==="failed")&&await m.deleteItem(r.id);t({success:!0});break;case"START_PROCESSING":await E(),t({success:!0});break;case"DEBUG_LOG":ce(e.message,(n=o.tab)==null?void 0:n.id),t({success:!0});break;default:t({success:!1,error:"Unknown message type"})}}catch(s){console.error("[Background] Error:",s),t({success:!1,error:s instanceof Error?s.message:"Unknown error"})}})(),!0));const D="apiBaseUrl";async function C(){return(await chrome.storage.local.get("maxConcurrent")).maxConcurrent||3}async function ie(){return(await chrome.storage.local.get(D))[D]||null}async function de(e){await chrome.storage.local.set({[D]:e})}async function k(e,o,t){const n=await ie();if(!n){console.log("[Background] No API base URL configured, skipping result report for leadId:",e);return}const s={results:[{leadId:e,status:o,error:t,sentAt:new Date().toISOString()}]};console.log("[Background] Reporting result to API:",{apiBaseUrl:n,leadId:e,status:o,error:t==null?void 0:t.substring(0,100)});try{const a=await fetch(`${n}/api/leads/update-send-result`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(a.ok){const r=await a.json();console.log("[Background] ✅ Result reported successfully:",{leadId:e,status:o,apiResponse:r})}else{const r=await a.text().catch(()=>"Unable to read error");console.error("[Background] ❌ API returned error:",{leadId:e,status:a.status,statusText:a.statusText,error:r})}}catch(a){console.error("[Background] ❌ Failed to report result to API:",{leadId:e,error:a instanceof Error?a.message:String(a),apiBaseUrl:n})}}chrome.runtime.onMessageExternal.addListener((e,o,t)=>(console.log("[Background] External message received:",e.type),(async()=>{try{switch(e.type){case"ADD_BATCH":o.origin&&(await de(o.origin),console.log(`[Background] API base URL set to: ${o.origin}`));let n=0;for(const g of e.items)try{await m.addItem(g),n++}catch(u){console.error("[Background] Failed to add item:",u)}t({success:!0,count:n}),await le(),console.log(`[Background] Starting queue processing for ${n} items`),setTimeout(()=>v(),500);break;case"GET_STATUS":const s=await m.getAllItems(),a=s.filter(g=>g.status==="processing").length,r=s.filter(g=>g.status==="pending").length,i=s.filter(g=>g.status==="completed").length,c=s.filter(g=>g.status==="failed").length;t({success:!0,data:{processing:a,pending:r,completed:i,failed:c,items:s}});break;case"PING":t({success:!0,message:"pong",version:"1.2.0"});break;case"GET_LOGS":t({success:!0,logs:p.slice(-100)});break;case"CLEAR_COMPLETED":await m.clearCompleted(),t({success:!0});break;case"GET_MAX_CONCURRENT":const l=await C();t({success:!0,maxConcurrent:l});break;case"SET_MAX_CONCURRENT":const d=e.maxConcurrent;typeof d=="number"&&d>=1&&d<=5?(await chrome.storage.local.set({maxConcurrent:d}),console.log(`[Background] Max concurrent set to: ${d}`),t({success:!0,maxConcurrent:d})):t({success:!1,error:"Invalid maxConcurrent value"});break;default:t({success:!1,error:"Unknown message type"})}}catch(n){console.error("[Background] External error:",n),t({success:!1,error:n instanceof Error?n.message:"Unknown error"})}})(),!0));async function v(){var s,a;const e=await C(),o=await m.getItemsByStatus("processing");if(o.length>=e){console.log(`[Background] Already processing ${o.length}/${e} items`);return}const t=await m.getAndLockNextPendingItem();if(!t){console.log("[Background] No pending items in queue");return}console.log(`[Background] Processing item: ${t.id} (${t.company}) [${o.length+1}/${e}]`),fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:213",message:"Starting to process queue item",data:{itemId:t.id,company:t.company,url:t.url},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"E"})}).catch(()=>{});let n=null;try{if(n=await chrome.tabs.create({url:t.url,active:!1}),!n.id)throw new Error("Failed to create tab");console.log(`[Background] Tab created: ${n.id} for URL: ${t.url}`),fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:230",message:"Tab created",data:{tabId:n.id,url:t.url,company:t.company},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"E"})}).catch(()=>{}),await q(n.id),console.log("[Background] Tab loaded, checking for contact form"),fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:239",message:"Tab loaded, checking for form",data:{tabId:n.id,url:t.url},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"F"})}).catch(()=>{});const{formUrl:r,attemptLogs:i}=await ue(n.id,t.url);if(console.log(`[Background] Form search completed. Attempts: ${i.length}`),i.forEach((l,d)=>{var g;console.log(`[Background] Attempt ${d}: ${l.toUrl} -> ${l.finalResult}`,{contentScriptReady:l.contentScriptReady,debugInfo:(g=l.checkForFormResult)==null?void 0:g.debugInfo})}),!r){const l=i.map(d=>{var g,u,L,x,O;return{url:d.toUrl,result:d.finalResult,hasForm:(g=d.checkForFormResult)==null?void 0:g.hasForm,formCount:(L=(u=d.checkForFormResult)==null?void 0:u.debugInfo)==null?void 0:L.formCount,inputCount:(O=(x=d.checkForFormResult)==null?void 0:x.debugInfo)==null?void 0:O.inputCount}});throw new Error(`フォームが見つかりません (${i.length}ページ試行: ${JSON.stringify(l)})`)}console.log(`[Background] Form found at: ${r}, sending form submission request`);const c=await Promise.race([h(n.id,{type:"FILL_AND_SUBMIT_FORM",payload:t}),new Promise(l=>setTimeout(()=>l({success:!1,error:"処理タイムアウト（2分）"}),12e4))]);if(console.log("[Background] Form submission result:",c),c.success)await m.updateItemStatus(t.id,"completed",{completedAt:new Date().toISOString(),finalUrl:c.finalUrl,debugLogs:(s=c.debugLogs)==null?void 0:s.join(`
`)}),console.log(`[Background] ✅ Item completed successfully: ${t.company}`),c.debugLogs&&console.log(`[Background] Logs:
${c.debugLogs.slice(-10).join(`
`)}`),await k(t.leadId,"success");else{const l=c.debugInfo?JSON.stringify(c.debugInfo,null,2):"";await m.updateItemStatus(t.id,"failed",{error:c.error||"Unknown error",failedAt:new Date().toISOString(),debugLogs:(a=c.debugLogs)==null?void 0:a.join(`
`),debugInfo:l}),console.log(`[Background] ❌ Item failed: ${t.company} - ${c.error}`),c.debugLogs&&console.log(`[Background] Debug logs:
${c.debugLogs.join(`
`)}`),l&&console.log(`[Background] Debug info: ${l}`),await k(t.leadId,"failed",c.error)}}catch(r){const i=r instanceof Error?r.message:"Unknown error";console.error(`[Background] Processing error for ${t.company}:`,i),await m.updateItemStatus(t.id,"failed",{error:i,failedAt:new Date().toISOString()}),await k(t.leadId,"failed",i)}finally{if(n!=null&&n.id)try{await chrome.tabs.remove(n.id),console.log(`[Background] Tab closed: ${n.id}`)}catch(r){console.log("[Background] Tab already closed or error closing:",r)}}setTimeout(()=>E(),1e3)}async function E(){const e=await C();for(let o=0;o<e;o++)v().catch(t=>console.error("[Background] Process error:",t)),await new Promise(t=>setTimeout(t,500))}async function h(e,o,t=3){console.log(`[Background] sendMessageToTab: tabId=${e}, type=${o.type}`);try{await chrome.scripting.executeScript({target:{tabId:e},files:["src/content/formHandler.js"]}),console.log(`[Background] Content Script injected successfully for tab ${e}`)}catch(s){console.log("[Background] Content Script injection failed (may already be injected):",s)}let n=!1;for(let s=1;s<=3;s++)try{const a=await chrome.tabs.sendMessage(e,{type:"PING_CONTENT"});if(a!=null&&a.ready){n=!0,console.log(`[Background] Content Script READY confirmed on attempt ${s}`);break}}catch(a){console.log(`[Background] PING attempt ${s}/3 failed:`,a),await P(500)}if(!n)return console.log("[Background] Content Script not ready after 3 PING attempts"),{success:!1,error:"Content Scriptが応答しません（注入失敗の可能性）"};for(let s=1;s<=t;s++)try{const a=await chrome.tabs.sendMessage(e,o);return console.log("[Background] Message sent successfully:",{tabId:e,attempt:s,messageType:o.type,resultSuccess:a==null?void 0:a.success}),a}catch(a){const r=a instanceof Error?a.message:String(a);if(console.log(`[Background] Message attempt ${s}/${t} failed:`,a),r.includes("back/forward cache")||r.includes("message channel closed")||r.includes("Receiving end does not exist"))try{const c=(await chrome.tabs.get(e)).url||"";if(["thanks","thank-you","thankyou","complete","success","sent","done","完了"].some(d=>c.toLowerCase().includes(d)))return console.log(`[Background] Page transitioned to success page: ${c}`),{success:!0,finalUrl:c}}catch(i){console.log("[Background] Could not check tab URL:",i)}s<t&&await P(1e3)}return{success:!1,error:"Content Scriptとの通信に失敗しました"}}async function q(e){fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:334",message:"waitForTabLoad started",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{});const o=await chrome.tabs.get(e);if(fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:343",message:"Tab status checked",data:{tabId:e,status:o.status,url:o.url},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),o.status==="complete"){fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:350",message:"Tab already complete, waiting 2s",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),await P(2e3),fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:356",message:"waitForTabLoad completed (already loaded)",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{});return}return new Promise((t,n)=>{fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:366",message:"Tab still loading, adding listener",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{});const s=setTimeout(()=>{chrome.tabs.onUpdated.removeListener(a),fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:374",message:"Tab load timeout",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),n(new Error("Tab load timeout (60s)"))},6e4),a=(r,i)=>{fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:385",message:"Tab update event",data:{updatedTabId:r,targetTabId:e,status:i.status,url:i.url},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),r===e&&i.status==="complete"&&(fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:392",message:"Tab load complete event received",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),clearTimeout(s),chrome.tabs.onUpdated.removeListener(a),setTimeout(()=>{fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"background/index.ts:401",message:"waitForTabLoad completed (after waiting)",data:{tabId:e},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),t()},2e3))};chrome.tabs.onUpdated.addListener(a)})}function P(e){return new Promise(o=>setTimeout(o,e))}async function ue(e,o){const t=[];console.log(`[Background] ===== Starting form page search for ${o} =====`);try{const n={attemptIndex:0,fromUrl:o,toUrl:o,timestamp:new Date().toISOString(),tabsUpdateResult:"success",waitForTabLoadResult:"success",contentScriptReady:!1,finalResult:"no_form"};console.log(`[Background] Attempt 0: Checking initial page ${o}`);const s=await h(e,{type:"CHECK_FOR_FORM"});if(n.contentScriptReady=!0,n.checkForFormResult={hasForm:(s==null?void 0:s.hasForm)||!1,debugInfo:s==null?void 0:s.debugInfo},s!=null&&s.hasForm)return n.finalResult="form_found",t.push(n),console.log("[Background] ✅ Attempt 0: Form found on initial page"),{formUrl:o,attemptLogs:t};t.push(n),console.log("[Background] Attempt 0: No form on initial page",s==null?void 0:s.debugInfo),console.log("[Background] Finding contact page candidates...");const a=await h(e,{type:"FIND_CONTACT_PAGE"}),r=(a==null?void 0:a.candidates)||[];if(console.log(`[Background] Found ${r.length} candidates:`,r.slice(0,5)),r.length<=1)return console.log("[Background] No additional candidates to try"),{formUrl:null,attemptLogs:t};for(let i=1;i<r.length;i++){const c=r[i],l=(await chrome.tabs.get(e)).url||o,d={attemptIndex:i,fromUrl:l,toUrl:c,timestamp:new Date().toISOString(),tabsUpdateResult:"success",waitForTabLoadResult:"success",contentScriptReady:!1,finalResult:"no_form"};console.log(`[Background] ----- Attempt ${i}: ${c} -----`);try{console.log(`[Background] Attempt ${i}: Navigating with chrome.tabs.update...`),await chrome.tabs.update(e,{url:c}),d.tabsUpdateResult="success",console.log(`[Background] Attempt ${i}: tabs.update succeeded`),console.log(`[Background] Attempt ${i}: Waiting for tab load...`),await q(e),d.waitForTabLoadResult="success",console.log(`[Background] Attempt ${i}: Tab load complete`);const g=await chrome.tabs.get(e);console.log(`[Background] Attempt ${i}: Tab URL after load: ${g.url}`),console.log(`[Background] Attempt ${i}: Checking for form...`);const u=await h(e,{type:"CHECK_FOR_FORM"});if(d.contentScriptReady=!0,d.checkForFormResult={hasForm:(u==null?void 0:u.hasForm)||!1,debugInfo:u==null?void 0:u.debugInfo},console.log(`[Background] Attempt ${i}: CHECK_FOR_FORM result:`,{hasForm:u==null?void 0:u.hasForm,debugInfo:u==null?void 0:u.debugInfo}),u!=null&&u.hasForm)return d.finalResult="form_found",t.push(d),console.log(`[Background] ✅ Attempt ${i}: Form found at ${c}`),{formUrl:c,attemptLogs:t};t.push(d),console.log(`[Background] Attempt ${i}: No form found`)}catch(g){const u=g instanceof Error?g.message:String(g);console.log(`[Background] ❌ Attempt ${i}: Error - ${u}`),u.includes("timeout")?(d.waitForTabLoadResult="timeout",d.waitForTabLoadError=u):u.includes("Content Script")||u.includes("応答しません")?d.contentScriptReady=!1:(d.tabsUpdateResult="error",d.tabsUpdateError=u),d.finalResult="error",t.push(d)}}return console.log(`[Background] ===== No form found in any of ${t.length} attempts =====`),{formUrl:null,attemptLogs:t}}catch(n){return console.error("[Background] Fatal error in findContactFormPage:",n),{formUrl:null,attemptLogs:t}}}chrome.runtime.onInstalled.addListener(async e=>{console.log("[Background] Extension installed:",e.reason),e.reason==="install"&&(await chrome.storage.local.set({isProcessing:!1}),console.log("[Background] Initial settings saved")),chrome.sidePanel&&(await chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),console.log("[Background] Side Panel configured"))});async function le(){try{if(!chrome.sidePanel){console.log("[Background] Side Panel API not available");return}const[e]=await chrome.windows.getAll({windowTypes:["normal"]});e!=null&&e.id&&(await chrome.sidePanel.open({windowId:e.id}),console.log("[Background] Side Panel opened"))}catch(e){console.log("[Background] Failed to open Side Panel:",e)}}chrome.tabs.onRemoved.addListener(async(e,o)=>{await m.getProcessingItem()&&console.log(`[Background] Tab ${e} closed while processing item`)});
