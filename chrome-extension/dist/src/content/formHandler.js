(function(){const E=window;if(E.__apottoFormHandlerLoaded){console.log("[Apotto Content] Already loaded, skipping re-initialization");return}E.__apottoFormHandlerLoaded=!0,console.log(`[Apotto Content] Loaded on ${window.location.href} (readyState: ${document.readyState})`);const _=[];function s(t){const o=`[${new Date().toISOString().substring(11,23)}] ${t}`;console.log(`[Apotto Content] ${o}`),_.push(o);try{chrome.runtime.sendMessage({type:"DEBUG_LOG",message:o}).catch(()=>{})}catch{}}function $(){return _.slice(-50)}chrome.runtime.onMessage.addListener((t,e,o)=>{var m;if(console.log(`[Apotto Content] Message received: ${t.type} on ${window.location.href}`),t.type==="PING_CONTENT")return console.log("[Apotto Content] PING received, responding READY"),o({success:!0,ready:!0,url:window.location.href}),!1;if(t.type==="FILL_AND_SUBMIT_FORM")return console.log(`[Apotto Content] Starting form submission for: ${(m=t.payload)==null?void 0:m.company}`),D(t.payload).then(i=>{console.log(`[Apotto Content] Form submission completed: success=${i.success}`),o(i)}).catch(i=>{console.error("[Apotto Content] Error:",i),o({success:!1,error:i instanceof Error?i.message:"Unknown error"})}),!0;if(t.type==="FIND_CONTACT_PAGE")return U().then(i=>{console.log(`[Apotto Content] Found ${i.length} contact page candidates`),o({success:!0,candidates:i})}).catch(i=>{o({success:!1,error:i instanceof Error?i.message:"Unknown error"})}),!0;if(t.type==="CHECK_FOR_FORM"){const i=P(),c=!!N();return console.log(`[Apotto Content] CHECK_FOR_FORM result: hasForm=${c}`,i),o({success:!0,hasForm:c,debugInfo:i}),!1}});function P(){const t=document.querySelectorAll("form"),e=document.querySelectorAll('input:not([type="hidden"])'),o=document.querySelectorAll("textarea"),m=document.querySelectorAll('input[type="email"], input[name*="mail" i]'),i=document.querySelectorAll("iframe"),l=document.querySelectorAll('button, input[type="submit"], input[type="button"]'),c=[];l.forEach(d=>{const a=(d.textContent||d.value||"").trim();a&&c.push(a.substring(0,30))});const n=Array.from(l).filter(d=>{const a=(d.textContent||d.value||"").toLowerCase();return a.includes("確認")||a.includes("入力内容")}),r=Array.from(l).filter(d=>{const a=(d.textContent||d.value||"").toLowerCase();return a.includes("送信")||a.includes("submit")});return{url:window.location.href,title:document.title,formCount:t.length,inputCount:e.length,textareaCount:o.length,hasEmailField:m.length>0,iframeCount:i.length,buttonCount:l.length,buttonTexts:c.slice(0,10),hasConfirmButton:n.length>0,confirmButtonCount:n.length,hasSubmitButton:r.length>0,submitButtonCount:r.length,readyState:document.readyState,timestamp:new Date().toISOString()}}async function U(){var a,u;const t=[],e=new Set,o=window.location.href;t.push(o),e.add(o),s("Searching for contact page candidates...");const m=['a[href*="contact"]','a[href*="inquiry"]','a[href*="toiawase"]','a[href*="otoiawase"]','a[href*="form"]'];for(const p of m)try{const y=document.querySelectorAll(p);for(const w of y){const f=w.href;f&&!e.has(f)&&A(f)&&(s(`Found contact link via selector ${p}: ${f}`),t.push(f),e.add(f))}}catch{s(`Selector ${p} failed`)}const i=["お問い合わせ","問い合わせ","お問合せ","問合せ","Contact","CONTACT","Inquiry","資料請求","その他","その他の","その他のお問い合わせ","other","others","一般","General"],l=document.querySelectorAll("a");for(const p of l){const y=((a=p.textContent)==null?void 0:a.trim())||"",w=p.href;if(!(!w||e.has(w)||!A(w))){for(const f of i)if(y.includes(f)){s(`Found contact link via text "${f}": ${w}`),t.push(w),e.add(w);break}}}const c=["nav","header","footer",".nav",".header",".footer","#nav","#header","#footer"];for(const p of c){const y=document.querySelector(p);if(!y)continue;const w=y.querySelectorAll("a");for(const f of w){const g=((u=f.textContent)==null?void 0:u.trim().toLowerCase())||"",b=f.href;!b||e.has(b)||!A(b)||(g.includes("問い合わせ")||g.includes("contact")||g.includes("inquiry")||b.includes("contact")||b.includes("inquiry"))&&(s(`Found nav contact link: ${b}`),t.push(b),e.add(b))}}const n=new URL(o),r=`${n.protocol}//${n.host}`,d=["/contact/other/","/contact/other","/contact/others/","/contact/others","/contact/others/form/","/contact/others/form.html","/contact/other/form/","/contact/other/form.html","/contact/form.php?type=service","/contact/form.php?type=other","/inquiry/other/","/inquiry/other","/inquiry/others/","/inquiry/others","/contact-other/","/contact-other","/contact-others/","/contact-others","/inquiry-other/","/inquiry-other","/inquiry-others/","/inquiry-others","/form-other/","/form-other","/form-others/","/form-others","/contact_other/","/contact_other","/contact_others/","/contact_others","/inquiry_other/","/inquiry_other","/inquiry_others/","/inquiry_others","/form_other/","/form_other","/form_others/","/form_others","/contact","/contact/","/contact/index.html","/contact/form.html","/inquiry","/inquiry/","/inquiry/index.html","/inquiry/office.html","/inquiry/form.html","/inquiry/contact.html","/toiawase","/toiawase/","/otoiawase","/otoiawase/","/お問い合わせ","/お問い合わせ/","/form","/form/","/form/contact","/form/contact/","/form/contactus","/form/contactus/","/form/inquiry","/form/inquiry/","/form/other/","/form/other","/form/others/","/form/others","/contact-us","/contact-us/","/contactus","/contactus/"];for(const p of d){const y=`${r}${p}`;e.has(y)||(t.push(y),e.add(y))}return s(`Found ${t.length} contact page candidates`),t}function A(t){try{return new URL(t).origin===window.location.origin}catch{return!1}}async function D(t){s(`Starting form submission for: ${t.company}`),fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"formHandler.ts:225",message:"handleFormSubmission started",data:{company:t.company,url:t.url,currentUrl:window.location.href},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"A"})}).catch(()=>{});try{const e=N();if(fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"formHandler.ts:251",message:"Form search result",data:{formFound:!!e,currentUrl:window.location.href},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),!e){const i=M();return s(`Debug info: forms=${i.formCount}, inputs=${i.inputCount}, email=${i.hasEmailField}, textarea=${i.hasTextarea}`),{success:!1,error:`フォームが見つかりません (forms=${i.formCount}, inputs=${i.inputCount})`,debugLogs:$(),debugInfo:i}}s("Form found, starting to fill..."),await j(e,t.formData),s("Form filled successfully");const o=await Y(e);return o.success?(await I(),q()?{success:!0,finalUrl:window.location.href,debugLogs:$()}:{...await W(),debugLogs:$()}):{success:!1,error:o.error,debugLogs:$()}}catch(e){let o="Unknown error";return e instanceof DOMException?(o=`DOMException: ${e.name} - ${e.message}`,s(`DOMException details: name=${e.name}, message=${e.message}`)):e instanceof Error&&(o=e.message,s(`Error details: ${e.name} - ${e.message}`)),console.error("[Apotto Content] Form submission error:",e),{success:!1,error:o,debugLogs:$()}}}function M(){var l;const t=document.querySelectorAll("form"),e=document.querySelectorAll('input:not([type="hidden"])'),o=document.querySelector('input[type="email"], input[name*="mail" i]'),m=document.querySelector("textarea"),i=document.querySelectorAll("iframe");return{url:window.location.href,title:document.title,formCount:t.length,inputCount:e.length,hasEmailField:!!o,hasTextarea:!!m,iframeCount:i.length,bodySnippet:((l=document.body.textContent)==null?void 0:l.substring(0,500).replace(/\s+/g," "))||""}}function N(){const t=document.querySelectorAll("form"),e=document.querySelectorAll('input[type="email"], input[name*="mail" i]'),o=document.querySelectorAll("textarea"),m=document.querySelectorAll('button, input[type="submit"], input[type="button"]');fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"formHandler.ts:358",message:"findContactForm started",data:{totalForms:t.length,totalEmailInputs:e.length,totalTextareas:o.length,totalButtons:m.length,url:window.location.href},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{});const i=[],l=document.querySelectorAll("form");for(const n of l){const r=B(n);r.score>0&&i.push({element:n,...r})}if(i.length===0){s("No form tags found, searching via buttons...");const n=H();for(const r of n){const d=B(r);d.score>0&&i.push({element:r,...d})}}i.sort((n,r)=>r.score-n.score);const c=n=>{const r=n.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]), textarea, select').length;return r<=3?30:r<=6?40:50};if(i.length>0){const n=i[0],r=c(n.element);return s(`Best form candidate: score=${n.score}, threshold=${r}, reasons=[${n.reasons.join(", ")}]`),n.score<r?(s(`Form score ${n.score} is below dynamic threshold ${r}, ignoring`),null):(fetch("http://127.0.0.1:7243/ingest/ae115290-0dc0-40f7-9966-129d981e7e81",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"formHandler.ts:450",message:"Form selected",data:{score:n.score,reasons:n.reasons,elementTag:n.element.tagName},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),n.element)}return s("No suitable form found"),null}function B(t){var b;let e=0;const o=[],m=t.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="checkbox"]):not([type="radio"])'),i=t.querySelectorAll("textarea"),l=t.querySelectorAll("select"),c=m.length+i.length+l.length;c>=5?(e+=40,o.push("5+ input fields")):c>=3?(e+=25,o.push("3+ input fields")):c>=2&&(e+=10,o.push("2+ input fields")),t.querySelector('input[type="email"], input[name*="mail" i]')&&(e+=50,o.push("has email field")),i.length>0&&(e+=30,o.push("has textarea")),t.querySelector('input[name*="name" i]:not([name*="company" i])')&&(e+=20,o.push("has name field")),t.querySelector('input[type="tel"], input[name*="tel" i], input[name*="phone" i]')&&(e+=15,o.push("has phone field"));const a=["送信","確認","submit","send","confirm","お問い合わせ","問い合わせ"],u=t.querySelectorAll('button, input[type="submit"], input[type="button"]');let p=!1;for(const h of u){const x=(h.textContent||h.value||"").toLowerCase();if(a.some(Q=>x.includes(Q.toLowerCase()))){p=!0;break}}if(p&&(e+=35,o.push("has submit/confirm button")),t.querySelector('input[type="checkbox"][name*="privacy" i], input[type="checkbox"][name*="agree" i], input[type="checkbox"][name*="consent" i]')&&(e+=10,o.push("has privacy checkbox")),t.querySelector('input[name*="company" i], input[name*="corp" i]')&&(e+=15,o.push("has company field")),t.tagName.toLowerCase()==="form"){const h=t;h.action&&(h.action.includes("contact")||h.action.includes("inquiry")||h.action.includes("mail"))&&(e+=25,o.push("form action contains contact keywords")),h.id&&(h.id.includes("contact")||h.id.includes("inquiry"))&&(e+=15,o.push("form id contains contact keywords"))}const f=((b=t.textContent)==null?void 0:b.substring(0,500).toLowerCase())||"";return(f.includes("お問い合わせ")||f.includes("contact")||f.includes("inquiry"))&&(e+=10,o.push("nearby text contains contact keywords")),(t.querySelector('input[type="search"]')!==null||t.getAttribute("role")==="search"||t.classList.contains("search")||t.tagName.toLowerCase()==="form"&&t.action.includes("search"))&&(e-=100,o.push("EXCLUDED: search form")),{score:e,reasons:o}}function H(){const t=[],e=new Set,o=["送信","確認","submit","send","confirm","お問い合わせ","問い合わせ","contact"],m=document.querySelectorAll('button, input[type="submit"], input[type="button"]');for(const i of m){const l=(i.textContent||i.value||"").toLowerCase();if(!o.some(d=>l.includes(d.toLowerCase())))continue;let n=i.parentElement,r=0;for(;n&&n!==document.body&&r<10&&!e.has(n);){const d=n.querySelectorAll('input:not([type="hidden"]):not([type="submit"]):not([type="button"]):not([type="checkbox"]):not([type="radio"]), textarea').length;if(d>=2){t.push(n),e.add(n),s(`Found pseudo-form via button "${l.substring(0,20)}" with ${d} inputs`);break}n=n.parentElement,r++}}return t}function R(t,e){var m;const o=t.querySelectorAll("label");for(const i of o){const l=((m=i.textContent)==null?void 0:m.trim().toLowerCase())||"",c=e.toLowerCase();if(l.includes(c)||c.includes(l)){const n=i.getAttribute("for");if(n){const u=t.querySelector(`#${n}`);if(u)return u}const r=i.querySelector("input, select");if(r)return r;const d=i.nextElementSibling;if(d&&(d.tagName==="INPUT"||d.tagName==="SELECT"))return d;const a=i.closest("dt");if(a){const u=a.nextElementSibling;if(u&&u.tagName==="DD"){const p=u.querySelector("input, select");if(p)return p}}}}return null}function K(t,e){var m;const o=t.querySelectorAll("label");for(const i of o){const l=((m=i.textContent)==null?void 0:m.trim().toLowerCase())||"",c=e.toLowerCase();if(l.includes(c)||c.includes(l)){const n=i.getAttribute("for");if(n){const u=t.querySelector(`#${n}`);if(u&&u.tagName==="TEXTAREA")return u}const r=i.querySelector("textarea");if(r)return r;const d=i.nextElementSibling;if(d&&d.tagName==="TEXTAREA")return d;const a=i.closest("dt");if(a){const u=a.nextElementSibling;if(u&&u.tagName==="DD"){const p=u.querySelector("textarea");if(p)return p}}}}return null}async function j(t,e){var d,a,u,p,y,w;const o=[{value:e.company,selectors:['input[name*="company" i]','input[name="groupname"]','input[name*="corp" i]','input[name*="organization" i]','input[name*="group" i]','input[name*="kaisha" i]','input[name*="kigyou" i]','input[placeholder*="会社" i]','input[placeholder*="企業" i]','input[placeholder*="法人" i]','input[placeholder*="company" i]','input[id*="company" i]','input[id*="corp" i]','input[id*="group" i]'],labelTexts:["会社名","企業名","法人名","組織名","company"]},{value:e.name||`${e.lastName||""} ${e.firstName||""}`.trim(),selectors:['input[name="name"]','input[name="your-name"]','input[name*="fullname" i]','input[name*="your_name" i]','input[name*="your-name" i]','input[name*="shimei" i]','input[name*="onamae" i]','input[name*="name" i]:not([name*="company" i]):not([name*="kana" i]):not([name*="first" i]):not([name*="last" i]):not([name*="sei" i]):not([name*="mei" i]):not([name*="group" i])','input[placeholder*="お名前" i]','input[placeholder*="名前" i]','input[placeholder*="氏名" i]','input[placeholder*="フルネーム" i]','input[id*="name" i]:not([id*="company" i]):not([id*="kana" i]):not([id*="group" i])','input[name="cname"]','input[name*="tantou" i]','input[name*="contact_name" i]','input[name*="contactname" i]','input[name*="person" i]:not([name*="company" i])','input[id*="cname" i]','input[id*="tantou" i]'],labelTexts:["お名前","名前","氏名","ご担当者名","担当者名","ご担当者","担当者","name"]},{value:e.lastName,selectors:['input[name*="sei" i]:not([name*="kana" i])','input[name*="lastname" i]','input[name*="last_name" i]','input[name*="family" i]','input[name*="surname" i]','input[name*="myoji" i]','input[placeholder*="姓" i]:not([placeholder*="ふりがな" i])','input[placeholder*="苗字" i]','input[id*="sei" i]:not([id*="kana" i])','input[id*="lastname" i]'],labelTexts:["姓","苗字","せい（漢字）","セイ（漢字）"]},{value:e.firstName,selectors:['input[name*="mei" i]:not([name*="kana" i]):not([name*="mail" i])','input[name*="firstname" i]','input[name*="first_name" i]','input[name*="given" i]','input[placeholder*="名" i]:not([placeholder*="氏名" i]):not([placeholder*="ふりがな" i])','input[id*="mei" i]:not([id*="kana" i])','input[id*="firstname" i]'],labelTexts:["名","めい（漢字）","メイ（漢字）"]},{value:e.lastNameKana,selectors:['input[name*="seikana" i]','input[name*="sei_kana" i]','input[name*="lastname_kana" i]','input[name*="last_kana" i]','input[name*="kana_sei" i]','input[name*="furigana_sei" i]','input[placeholder*="せい" i]','input[placeholder*="セイ" i]','input[id*="seikana" i]','input[id*="lastname_kana" i]'],labelTexts:["せい","セイ","せい（ふりがな）","セイ（フリガナ）","せい（よみ）","セイ（ヨミ）"]},{value:e.firstNameKana,selectors:['input[name*="meikana" i]','input[name*="mei_kana" i]','input[name*="firstname_kana" i]','input[name*="first_kana" i]','input[name*="kana_mei" i]','input[name*="furigana_mei" i]','input[placeholder*="めい" i]','input[placeholder*="メイ" i]','input[id*="meikana" i]','input[id*="firstname_kana" i]'],labelTexts:["めい","メイ","めい（ふりがな）","メイ（フリガナ）","めい（よみ）","メイ（ヨミ）"]},{value:e.fullNameKana||`${e.lastNameKana||""} ${e.firstNameKana||""}`.trim(),selectors:['input[name*="kana" i]:not([name*="sei" i]):not([name*="mei" i]):not([name*="last" i]):not([name*="first" i])','input[name*="furigana" i]:not([name*="sei" i]):not([name*="mei" i])','input[name*="yomi" i]','input[placeholder*="ふりがな" i]','input[placeholder*="フリガナ" i]','input[placeholder*="カナ" i]','input[id*="kana" i]:not([id*="sei" i]):not([id*="mei" i])'],labelTexts:["フリガナ","ふりがな","カナ","よみ"]},{value:e.email,selectors:['input[type="email"]:not([name*="confirm" i]):not([name*="check" i]):not([name*="kakunin" i]):not([name*="re_" i]):not([name*="re-" i]):not([name$="2" i])','input[name="email"]:not([name*="confirm" i]):not([name*="check" i]):not([name*="kakunin" i])','input[name="mail"]:not([name*="confirm" i]):not([name*="check" i]):not([name*="kakunin" i])','input[name*="email" i]:not([name*="confirm" i]):not([name*="check" i]):not([name*="kakunin" i]):not([name*="re_" i]):not([name*="re-" i]):not([name*="remail" i]):not([name$="2" i])','input[name*="mail" i]:not([name*="confirm" i]):not([name*="check" i]):not([name*="kakunin" i]):not([name*="re_" i]):not([name*="re-" i]):not([name*="remail" i]):not([name$="2" i])','input[placeholder*="メール" i]:not([placeholder*="確認" i]):not([placeholder*="再入力" i])','input[placeholder*="mail" i]:not([placeholder*="確認" i]):not([placeholder*="再" i])','input[placeholder*="email" i]:not([placeholder*="確認" i]):not([placeholder*="再" i])','input[placeholder*="E-mail" i]:not([placeholder*="確認" i]):not([placeholder*="再" i])','input[id*="email" i]:not([id*="confirm" i]):not([id*="check" i]):not([id*="kakunin" i]):not([id$="2" i])','input[id*="mail" i]:not([id*="confirm" i]):not([id*="check" i]):not([id*="kakunin" i]):not([id$="2" i])'],labelTexts:["メールアドレス","E-mail","email","mail"]},{value:e.email,selectors:['input[name*="email_check" i]','input[name*="email_confirm" i]','input[name*="mail_confirm" i]','input[name*="mail_check" i]','input[name*="confirm_email" i]','input[name*="confirm_mail" i]','input[name*="mailconfirm" i]','input[name*="emailconfirm" i]','input[name*="kakunin" i]','input[name*="mailkakunin" i]','input[name*="emailkakunin" i]','input[name*="re_email" i]','input[name*="re_mail" i]','input[name*="remail" i]','input[name*="reemail" i]','input[name*="reenter" i]','input[name*="reinput" i]','input[name*="sainyuryoku" i]','input[name*="email2" i]','input[name*="mail2" i]','input[name*="email-2" i]','input[name*="mail-2" i]','input[placeholder*="確認" i]','input[placeholder*="再入力" i]','input[placeholder*="もう一度" i]','input[id*="email_confirm" i]','input[id*="mail_confirm" i]','input[id*="mailkakunin" i]','input[id*="email2" i]','input[id*="mail2" i]'],labelTexts:["メールアドレス再入力","メール再入力","確認用","再入力","もう一度","メールアドレス（確認）","E-mail（確認）"]},{value:e.phone,selectors:['input[type="tel"]','input[name*="tel" i]','input[name*="phone" i]','input[name*="denwa" i]','input[placeholder*="電話" i]','input[placeholder*="TEL" i]','input[placeholder*="Phone" i]','input[id*="tel" i]','input[id*="phone" i]'],labelTexts:["電話番号","TEL","連絡先","phone"]},{value:e.postalCode,selectors:['input[name*="zip" i]','input[name*="postal" i]','input[name*="postcode" i]','input[name*="yubin" i]','input[placeholder*="郵便" i]','input[placeholder*="〒" i]','input[id*="zip" i]','input[id*="postal" i]'],labelTexts:["郵便番号","〒"]},{value:e.prefecture,selectors:['select[name*="pref" i]','select[name*="ken" i]','select[name*="todofuken" i]','input[name*="pref" i]','input[name*="ken" i]','input[placeholder*="都道府県" i]','select[id*="pref" i]']},{value:e.city,selectors:['input[name*="city" i]','input[name*="shiku" i]','input[name*="address1" i]','input[placeholder*="市区町村" i]','input[id*="city" i]']},{value:e.address,selectors:['input[name*="address" i]:not([name*="mail" i])','input[name*="jusho" i]','input[name*="address2" i]','input[name*="street" i]','input[placeholder*="住所" i]','input[placeholder*="番地" i]','input[id*="address" i]:not([id*="mail" i])'],labelTexts:["住所","所在地","address"]},{value:e.department,selectors:['input[name="section"]','input[name*="depart" i]','input[name*="busho" i]','input[name*="division" i]','input[name*="section" i]','input[name*="bu" i]:not([name*="submit" i]):not([name*="button" i])','input[placeholder*="部署" i]','input[placeholder*="所属" i]','input[id*="depart" i]','input[id*="busho" i]','input[id*="section" i]'],labelTexts:["部署名","部署","所属","所属部署"]},{value:e.title,selectors:['input[name*="title" i]:not([name*="subtitle" i])','input[name*="yakushoku" i]','input[name*="position" i]','input[name*="post" i]','input[placeholder*="役職" i]','input[id*="title" i]','input[id*="position" i]']},{value:e.subject,selectors:['input[name*="subject" i]','input[name*="title" i]','input[name*="kenmei" i]','input[placeholder*="件名" i]','input[placeholder*="タイトル" i]','input[id*="subject" i]']}];for(const f of o){if(!f.value)continue;let g=!1;for(const b of f.selectors)try{const h=t.querySelector(b);if(h&&!h.value){await L(h,f.value),s(`Filled: ${b} = ${f.value.substring(0,20)}...`),g=!0;break}}catch{}if(!g&&f.labelTexts)for(const b of f.labelTexts){const h=R(t,b);if(h&&!h.value){await L(h,f.value),s(`Filled via label "${b}": ${h.name||h.id} = ${f.value.substring(0,20)}...`),g=!0;break}}}if(e.message){const f=['textarea[name*="message" i]','textarea[name*="body" i]','textarea[name*="content" i]','textarea[name*="inquiry" i]','textarea[name*="comment" i]','textarea[name*="naiyou" i]','textarea[name*="detail" i]','textarea[placeholder*="お問い合わせ" i]','textarea[placeholder*="内容" i]','textarea[placeholder*="メッセージ" i]','textarea[id*="message" i]','textarea[id*="content" i]',"textarea"];let g=!1;for(const b of f){const h=t.querySelector(b);if(h){await L(h,e.message),s(`Filled textarea: ${b}`),g=!0;break}}if(!g){const b=["お問い合わせ内容","問い合わせ内容","メッセージ","内容","ご意見"];for(const h of b){const x=K(t,h);if(x){await L(x,e.message),s(`Filled textarea via label "${h}": ${x.name||x.id}`);break}}}}const m=new Set,i=t.querySelectorAll('input[type="checkbox"]');for(const f of i){const g=f.name;if(g&&g.includes("[]")){const b=g.replace("[]","");m.add(b)}}for(const f of m){const g=t.querySelectorAll(`input[type="checkbox"][name="${f}[]"]`);if(!Array.from(g).some(h=>h.checked)&&g.length>0){const h=g[0];h.click();const x=((a=(d=h.closest("label"))==null?void 0:d.textContent)==null?void 0:a.trim())||h.value;s(`Checked first checkbox in group "${f}": ${x}`),await k(100)}}const l=['input[type="checkbox"][required]','input[type="checkbox"][name*="agree" i]','input[type="checkbox"][name*="privacy" i]','input[type="checkbox"][name*="consent" i]','input[type="checkbox"][name*="terms" i]','input[type="checkbox"][name*="policy" i]','input[type="checkbox"][name*="doui" i]','input[type="checkbox"][id*="agree" i]','input[type="checkbox"][id*="privacy" i]'];for(const f of l){const g=t.querySelectorAll(f);for(const b of g)if(!b.checked){if(b.disabled){if(s("Checkbox is disabled, attempting to enable by scrolling..."),!await J(b)){s("Failed to enable checkbox by scrolling, skipping...");continue}s("Checkbox enabled successfully after scrolling")}b.click(),s(`Checked required checkbox: ${f}`),await k(50)}}const c=t.querySelectorAll("select:not([disabled])");for(const f of c)if(!f.value||f.value===""){const g=f.querySelectorAll("option");for(const b of g){const h=((u=b.textContent)==null?void 0:u.trim().toLowerCase())||"";if(!(!b.value||b.value===""||h.includes("選択")||h.includes("select")||h==="-"||h==="--")&&!b.disabled){f.value=b.value,f.dispatchEvent(new Event("change",{bubbles:!0})),s(`Selected option: ${b.value} (${(p=b.textContent)==null?void 0:p.trim()})`);break}}}const n=new Set,r=t.querySelectorAll('input[type="radio"]');for(const f of r)f.name&&n.add(f.name);for(const f of n){const g=t.querySelectorAll(`input[type="radio"][name="${f}"]`);if(!Array.from(g).some(h=>h.checked)&&g.length>0)for(const h of g){const x=((w=(y=h.closest("label"))==null?void 0:y.textContent)==null?void 0:w.trim())||"";if(!x.includes("その他")&&!x.toLowerCase().includes("other")){h.click(),s(`Selected radio: ${f} = ${h.value}`);break}}}}function G(t){return t.replace(/[\u30A1-\u30F6]/g,e=>{const o=e.charCodeAt(0)-96;return String.fromCharCode(o)})}function z(t){return t.replace(/[\u3041-\u3096]/g,e=>{const o=e.charCodeAt(0)+96;return String.fromCharCode(o)})}function V(t){var c,n,r,d;if(t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)return"auto";const e=t.id,m=t.name.toLowerCase();let i=!1;if((m.includes("kana")||m.includes("furigana")||m.includes("yomi")||m.includes("hurigana"))&&(i=!0),!i){let a="";if(e){const u=document.querySelector(`label[for="${e}"]`);u&&(a=((c=u.textContent)==null?void 0:c.trim().toLowerCase())||"")}if(!a){const u=(n=t.closest("dd"))==null?void 0:n.previousElementSibling;u&&u.tagName==="DT"&&(a=((r=u.textContent)==null?void 0:r.trim().toLowerCase())||"")}a&&(i=a.includes("ふりがな")||a.includes("ふりがな")||a.includes("よみ")||a.includes("カナ")||a==="せい"||a==="めい")}if(!i)return"auto";if(e){const a=document.querySelector(`label[for="${e}"]`);if(a){const u=a.textContent||"";if(u.includes("ふりがな")||u.includes("よみ")||u==="せい"||u==="めい")return"hiragana";if(u.includes("フリガナ")||u.includes("ヨミ")||u.includes("カナ")||u==="セイ"||u==="メイ")return"katakana"}}const l=(d=t.closest("dd"))==null?void 0:d.previousElementSibling;if(l&&l.tagName==="DT"){const a=l.textContent||"";if(a.includes("ふりがな")||a.includes("よみ")||a==="せい"||a==="めい")return"hiragana";if(a.includes("フリガナ")||a.includes("ヨミ")||a.includes("カナ")||a==="セイ"||a==="メイ")return"katakana"}if(t instanceof HTMLInputElement){const a=t.placeholder||"";if(a.includes("ふりがな")||a.includes("よみ")||a==="せい"||a==="めい")return"hiragana";if(a.includes("フリガナ")||a.includes("カナ")||a==="セイ"||a==="メイ")return"katakana"}return m.includes("kana")||m.includes("furigana")||m.includes("yomi")?"katakana":"auto"}async function L(t,e){var o,m,i;if(t.focus(),await k(50),t instanceof HTMLSelectElement){const l=t.querySelectorAll("option");for(const c of l)if(c.value===e||((o=c.textContent)==null?void 0:o.trim())===e){t.value=c.value,t.dispatchEvent(new Event("change",{bubbles:!0}));break}}else{let l=e;const c=V(t);c==="katakana"?l=z(e):c==="hiragana"&&(l=G(e)),l=l.normalize("NFC"),t.value="";const n=(m=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"value"))==null?void 0:m.set,r=(i=Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value"))==null?void 0:i.set;t.dispatchEvent(new CompositionEvent("compositionstart",{bubbles:!0})),await k(10),t instanceof HTMLTextAreaElement&&r?r.call(t,l):t instanceof HTMLInputElement&&n?n.call(t,l):t.value=l,t.dispatchEvent(new Event("input",{bubbles:!0})),await k(10);const d=new InputEvent("input",{bubbles:!0,cancelable:!0,inputType:"insertText",data:l});t.dispatchEvent(d),await k(10),t.dispatchEvent(new CompositionEvent("compositionend",{bubbles:!0,data:l})),await k(10),t.dispatchEvent(new Event("change",{bubbles:!0}))}t.blur(),t.dispatchEvent(new FocusEvent("blur",{bubbles:!0})),await k(150)}async function Y(t){const e=["検索","search","ログイン","login","登録","register","キャンセル","cancel","リセット","reset","クリア","clear","戻る","back"];s("Searching for buttons in form...");const o=t.querySelectorAll('button, input[type="submit"], input[type="button"]');let m=null;for(const c of o){if(!T(c))continue;const n=C(c),r=n.toLowerCase();if(!e.some(d=>r.includes(d.toLowerCase()))&&(n.includes("確認")||r.includes("confirm")||r.includes("check"))){m=c,s(`Found confirm button by text: "${n}"`);break}}if(m){s(`Clicking confirm button: ${F(m)}`);const c=m;m.click(),await k(500);const n=window.location.href;if(S(n))return s(`✅ Success page detected by URL: ${n}`),{success:!0};if(v())return s("✅ Success detected by page text"),{success:!0};s("Confirmation page detected, searching for final submit button (using MutationObserver)...");const r=["送信","submit","send","完了","ok"],d=await O([...e,"確認","confirm","check"],r,5e3);if(d&&d!==c){const u=C(d);s(`Found final submit button: "${u}"`),d.click(),s("Waiting for submission completion (2s)..."),await k(2e3);const p=window.location.href;return S(p)?(s(`✅ Success page detected by URL: ${p}`),{success:!0}):v()?(s("✅ Success detected by page text"),{success:!0}):(s("✅ Submit button clicked successfully"),{success:!0})}s("MutationObserver timeout, falling back to manual search..."),await k(1e3);const a=document.querySelectorAll('button, input[type="submit"], input[type="button"]');for(const u of a){if(!T(u)||u===c)continue;const p=C(u),y=p.toLowerCase();if(!e.some(w=>y.includes(w.toLowerCase()))&&!(p.includes("確認")||y.includes("confirm")||y.includes("check"))&&(p.includes("送信")||y.includes("submit")||y.includes("send")))return s(`Found final submit button (fallback): "${p}"`),u.click(),await k(2e3),S(window.location.href)||v()?(s("✅ Success detected"),{success:!0}):(s("✅ Submit button clicked"),{success:!0})}for(const u of a){if(!T(u)||u===c)continue;const p=C(u),y=p.toLowerCase();if(e.some(f=>y.includes(f.toLowerCase()))||p.includes("確認"))continue;if(u.type==="submit"||u.tagName==="BUTTON")return s(`Found generic submit button (fallback): "${p}"`),u.click(),await k(2e3),S(window.location.href)||v()?(s("✅ Success detected"),{success:!0}):(s("✅ Submit button clicked"),{success:!0})}return s("❌ Final submit button not found after confirm"),{success:!1,error:"確認ボタンを押下しましたが、最終送信ボタンが見つかりませんでした"}}s("No confirm button found, searching for submit button...");let i=null;for(const c of o){if(!T(c))continue;const n=C(c),r=n.toLowerCase();if(!e.some(d=>r.includes(d.toLowerCase()))&&!(n.includes("確認")||r.includes("confirm")||r.includes("check"))&&(n.includes("送信")||r.includes("submit")||r.includes("send"))){i=c,s(`Found submit button by text: "${n}"`);break}}if(!i)for(const c of o){if(!T(c))continue;const n=C(c),r=n.toLowerCase();if(e.some(a=>r.includes(a.toLowerCase()))||n.includes("確認")||r.includes("confirm")||r.includes("check"))continue;if(c.type==="submit"||c.tagName==="BUTTON"){i=c,s(`Found generic submit button: "${n}"`);break}}if(i){s(`Clicking submit button: ${F(i)}`),i.click(),s("Waiting for submission completion (2s)..."),await k(2e3);const c=window.location.href;return S(c)?(s(`✅ Success page detected by URL: ${c}`),{success:!0}):v()?(s("✅ Success detected by page text"),{success:!0}):(s("✅ Submit button clicked successfully"),{success:!0})}s("No button found in form, searching in entire document...");const l=document.querySelectorAll('button, input[type="submit"], input[type="button"]');for(const c of l){if(!T(c))continue;const n=C(c),r=n.toLowerCase();if(!e.some(d=>r.includes(d.toLowerCase()))&&(n.includes("確認")||r.includes("confirm")||r.includes("check"))){s(`Found confirm button in document: "${n}"`);const d=c;if(c.click(),await k(500),S(window.location.href)||v())return s("✅ Success after confirm button click"),{success:!0};s("Searching for final submit button after confirm (using MutationObserver)...");const a=["送信","submit","send","完了","ok"],u=await O([...e,"確認","confirm","check"],a,5e3);if(u&&u!==d){const y=C(u);return s(`Found final submit button: "${y}"`),u.click(),await k(2e3),S(window.location.href)||v()?(s("✅ Success after final submit"),{success:!0}):(s("✅ Final submit button clicked"),{success:!0})}s("MutationObserver timeout, falling back to manual search..."),await k(1e3);const p=document.querySelectorAll('button, input[type="submit"], input[type="button"]');for(const y of p){if(!T(y)||y===d)continue;const w=C(y),f=w.toLowerCase();if(!e.some(g=>f.includes(g.toLowerCase()))&&!w.includes("確認")&&(w.includes("送信")||f.includes("submit")||f.includes("send")))return s(`Found final submit button (fallback): "${w}"`),y.click(),await k(2e3),S(window.location.href)||v()?(s("✅ Success after final submit"),{success:!0}):(s("✅ Final submit button clicked"),{success:!0})}return s("❌ Final submit button not found after confirm"),{success:!1,error:"確認ボタンを押下しましたが、最終送信ボタンが見つかりませんでした"}}}for(const c of l){if(!T(c))continue;const n=C(c),r=n.toLowerCase();if(!e.some(d=>r.includes(d.toLowerCase()))&&!n.includes("確認")&&(n.includes("送信")||r.includes("submit")||r.includes("send")))return s(`Found submit button in document: "${n}"`),c.click(),await k(2e3),S(window.location.href)||v()?(s("✅ Success after submit"),{success:!0}):(s("✅ Submit button clicked"),{success:!0})}return s("❌ No submit/confirm button found"),{success:!1,error:"送信ボタンまたは確認ボタンが見つかりません"}}function C(t){var e;return t?t instanceof HTMLInputElement?t.value||"":((e=t.textContent)==null?void 0:e.trim())||"":""}function T(t){if(t.offsetParent===null&&t.style.display!=="contents")return!1;const e=window.getComputedStyle(t);return!(e.display==="none"||e.visibility==="hidden"||e.opacity==="0")}async function J(t){var i;s("Attempting to enable checkbox by scrolling...");let e=null,o=t.parentElement;for(;o&&o!==document.body;){const l=window.getComputedStyle(o);if((l.overflowY==="scroll"||l.overflowY==="auto"||l.overflow==="scroll"||l.overflow==="auto")&&o.scrollHeight>o.clientHeight){e=o,s(`Found scrollable element: ${o.tagName}.${o.className}`);break}o=o.parentElement}if(!e){const l=(i=t.closest("form, .form, .modal, .dialog, .container"))==null?void 0:i.querySelectorAll('div[style*="overflow"], div[style*="scroll"], textarea');if(l)for(const c of l){const n=c,r=window.getComputedStyle(n);if((r.overflowY==="scroll"||r.overflowY==="auto"||r.overflow==="scroll"||r.overflow==="auto")&&n.scrollHeight>n.clientHeight){e=n,s(`Found scrollable element by search: ${n.tagName}.${n.className}`);break}}}if(!e)return s("No scrollable element found"),!1;s("Scrolling to bottom of element..."),e.scrollTop=e.scrollHeight;const m=30;for(let l=0;l<m;l++){if(await k(100),!t.disabled)return s(`Checkbox enabled after ${l*100}ms`),!0;l%5===0&&(e.scrollTop=e.scrollHeight)}return s(`Checkbox still disabled after ${m*100}ms`),!1}function S(t){const e=["thanks","thank-you","thankyou","thank_you","thank","success","successful","complete","completed","completion","done","finish","finished","sent","submitted","submission","received","confirmed","status=ok","status=success","status=complete","result=ok","result=success","mode=complete","mode=thanks","mode=finish","完了","ありがとう","送信完了","受付完了"],o=t.toLowerCase();let m=o;try{m=decodeURIComponent(o)}catch{}return e.some(i=>o.includes(i)||m.includes(i))}function v(){const e=(document.body.textContent||"").toLowerCase(),o=["ありがとうございました","ありがとうございます","お問い合わせを受け付けました","お問い合わせいただきありがとう","お問い合わせありがとう","送信完了","送信しました","送信が完了しました","送信が完了","送信されました","受け付けました","受付完了","完了しました","完了いたしました","お問い合わせいただき","送信いただき","お送りいただき","承りました","受信しました","受領しました","問い合わせを受け付け","お問合せを受け付け","メールをお送りしました","確認メールを送信","自動返信メール","お問い合わせ番号","受付番号","お問い合わせ内容を確認しました","内容を送信しました","ご連絡を受け付けました","フォームを送信しました","正常に送信されました","入力内容を受け付けました","ご意見を受け付けました","ご感想を受け付けました","thank you","thanks for","successfully submitted","message sent","inquiry received","request received","submission successful","form submitted","message has been sent","your message has been","we have received","we received your","has been submitted","was submitted successfully","email has been sent","confirmation email","your inquiry","your request has been","form has been submitted"];for(const m of o)if(e.includes(m.toLowerCase()))return s(`Success keyword detected: "${m}"`),!0;return!1}function X(t,e,o){var m,i,l,c;if(e.includes(":has-text")){const n=e.match(/:has-text\("([^"]+)"\)/);if(n){const r=n[1],d=e.replace(/:has-text\("[^"]+"\)/,""),a=t.querySelectorAll(d||"button");for(const u of a){const p=((m=u.textContent)==null?void 0:m.toLowerCase())||((i=u.value)==null?void 0:i.toLowerCase())||"";if(!o.some(y=>p.includes(y.toLowerCase()))&&p.includes(r.toLowerCase())){if(u.offsetParent===null&&u.style.display!=="contents")continue;return u}}return null}}try{const n=t.querySelectorAll(e);for(const r of n){const d=((l=r.textContent)==null?void 0:l.toLowerCase())||((c=r.value)==null?void 0:c.toLowerCase())||"";if(!o.some(a=>d.includes(a.toLowerCase()))&&!(r.offsetParent===null&&r.style.display!=="contents"))return r}}catch{}return null}function F(t){var c;const e=t.tagName.toLowerCase(),o=t.getAttribute("type")||"",m=t.value||"",i=((c=t.textContent)==null?void 0:c.trim().substring(0,30))||"",l=t.id||"";return`<${e} type="${o}" value="${m}" id="${l}">${i}</${e}>`}async function W(){if(s("Checking for confirmation page..."),await k(2e3),q())return{success:!0,finalUrl:window.location.href};const t=["戻る","back","修正","キャンセル","cancel","確認","confirm"],e=['input[type="submit"][value*="送信"]','input[type="button"][value*="送信"]',"#sendmail_btn",'button:has-text("送信")','input[type="submit"]:not([value*="確認"])','button[type="submit"]','input[type="button"][onclick*="submit" i]'];for(const o of e){const m=X(document.body,o,t);if(m&&(s(`Found final submit button: ${F(m)}`),await k(200),m.click(),await I(),await k(1e3),q()))return{success:!0,finalUrl:window.location.href}}return await k(1e3),q()?{success:!0,finalUrl:window.location.href}:{success:!1,error:"最終送信ボタンが見つかりません"}}function q(){var c;const t=window.location.href.toLowerCase(),e=((c=document.body.textContent)==null?void 0:c.toLowerCase())||"",o=document.title.toLowerCase();return["thanks","thank-you","thankyou","thank_you","success","complete","completed","done","finish","finished","sent","submit_ok","ok.html","result"].some(n=>t.includes(n))?(s(`Success page detected via URL: ${t}`),!0):["ありがとう","完了","送信","thank","complete"].some(n=>o.includes(n))?(s(`Success page detected via title: ${o}`),!0):["ありがとうございます","ありがとうございました","送信完了","送信が完了","送信されました","受け付けました","受付完了","お問い合わせを受け付け","お問合せを受け付け","thank you for","successfully submitted","has been sent","inquiry has been received"].some(n=>e.includes(n))?(s("Success page detected via body text"),!0):!1}function I(){return new Promise(t=>{let e=!1;const o=setTimeout(()=>{e||(e=!0,t())},1e4),m=window.location.href,i=setInterval(()=>{window.location.href!==m&&(clearInterval(i),clearTimeout(o),e||(e=!0,setTimeout(t,1500)))},100),l=new MutationObserver(()=>{var n;const c=((n=document.body.textContent)==null?void 0:n.toLowerCase())||"";(c.includes("ありがとう")||c.includes("送信完了")||c.includes("thank you"))&&(l.disconnect(),clearInterval(i),clearTimeout(o),e||(e=!0,setTimeout(t,500)))});l.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{l.disconnect()},1e4)})}function k(t){return new Promise(e=>setTimeout(e,t))}async function O(t,e,o=5e3){return new Promise(m=>{let i=!1;const l=Date.now(),c=new Set;document.querySelectorAll('button, input[type="submit"], input[type="button"]').forEach(a=>{c.add(a)});const n=()=>{var u;const a=document.querySelectorAll('button, input[type="submit"], input[type="button"]');for(const p of a){if(p.offsetParent===null&&p.style.display!=="contents")continue;const y=(((u=p.textContent)==null?void 0:u.trim())||p.value||"").toLowerCase();if(!t.some(w=>y.includes(w.toLowerCase()))&&e.some(w=>y.includes(w.toLowerCase())))return p}return null},r=setInterval(()=>{var u;if(i)return;const a=n();if(a&&!c.has(a)&&(clearInterval(r),d.disconnect(),i=!0,s(`[MutationObserver] New button found: "${((u=a.textContent)==null?void 0:u.trim())||a.value}"`),m(a)),Date.now()-l>o&&(clearInterval(r),d.disconnect(),!i)){i=!0;const p=n();m(p)}},200),d=new MutationObserver(()=>{var u;if(i)return;const a=n();a&&!c.has(a)&&(clearInterval(r),d.disconnect(),i=!0,s(`[MutationObserver] New button found via mutation: "${((u=a.textContent)==null?void 0:u.trim())||a.value}"`),m(a))});d.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","disabled","hidden"]}),setTimeout(()=>{if(!i){clearInterval(r),d.disconnect(),i=!0;const a=n();m(a)}},o)})}s("Form handler content script loaded (scoring-based search)")})();
