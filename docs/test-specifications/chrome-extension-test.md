# Chrome拡張機能テスト仕様書

最終更新: 2026-02-06

## 📋 概要

Chrome拡張機能によるフォーム自動送信機能のテスト仕様書。

---

## テスト実施ステータス

| カテゴリ       | 実施日 | 結果 | 担当者 |
| -------------- | ------ | ---- | ------ |
| 拡張機能の接続 | -      | -    | -      |
| 並行処理       | -      | -    | -      |
| フォーム送信   | -      | -    | -      |
| 送信結果管理   | -      | -    | -      |
| キュー管理     | -      | -    | -      |

---

## 1. Chrome拡張機能の接続テスト

### 1.1 拡張機能インストール

**前提条件**: Chrome拡張機能がインストールされていない状態

**テスト手順**:

1. apottoアプリを開く
2. 「⚠️ Chrome拡張機能が未接続です」と表示されることを確認
3. Chrome拡張機能をインストール
4. ページを再読み込み
5. 「✓ Chrome拡張機能に接続中」と表示されることを確認

**期待結果**:

- ✅ 警告メッセージ→接続メッセージに変化
- ✅ 送信ボタンが有効化される

### 1.2 拡張機能の通信

**テスト手順**:

1. 拡張機能が接続された状態でアプリを開く
2. ブラウザのDevToolsコンソールを開く
3. ネットワークエラーがないことを確認

**期待結果**:

- ✅ Chrome API通信エラーなし
- ✅ Extension IDが環境変数から正しく読み込まれている

---

## 2. 並行処理テスト

### 2.1 並行タブ数の設定

**テスト手順**:

1. リード一覧の「並行数:」ドロップダウンを確認
2. 1-5の選択肢があることを確認
3. 各値を選択して保存されるか確認
4. Chrome拡張機能のPopupで並行タブ数が反映されているか確認

**期待結果**:

- ✅ 1-5の選択肢が表示される
- ✅ 選択した値が拡張機能に保存される
- ✅ Popup上部に「並行タブ数: ○並行」と表示される

### 2.2 1並行での送信

**テスト手順**:

1. 並行数を「1」に設定
2. 3件のリードを選択して送信
3. Chrome拡張機能Popupで処理状況を確認

**期待結果**:

- ✅ 処理中が常に0または1
- ✅ 1件ずつ順次処理される
- ✅ タブが1つずつ開いて閉じる

### 2.3 3並行での送信

**テスト手順**:

1. 並行数を「3」に設定
2. 10件のリードを選択して送信
3. 処理中に最大3件が同時処理されるか確認

**期待結果**:

- ✅ 処理中が最大3になる
- ✅ 同時に3つのタブが開く
- ✅ 1並行の約3倍の速度

### 2.4 5並行での送信

**テスト手順**:

1. 並行数を「5」に設定
2. 10件のリードを選択して送信
3. PCリソースを確認

**期待結果**:

- ✅ 処理中が最大5になる
- ✅ 同時に5つのタブが開く
- ✅ PCが過負荷にならない

---

## 3. フォーム送信テスト

### 3.1 シンプルフォーム

**テスト対象**: 基本的な項目のみのフォーム（会社名、名前、メール、メッセージ）

**テスト手順**:

1. シンプルフォームを持つ企業を選択
2. 送信を実行
3. 拡張機能のログを確認

**期待結果**:

- ✅ フォームが自動検出される
- ✅ すべてのフィールドに正しく入力される
- ✅ 送信ボタンがクリックされる
- ✅ 「成功」と記録される

### 3.2 複雑フォーム（ふりがな、住所など）

**テスト対象**: ふりがな、住所、電話番号などを含む詳細フォーム

**テスト手順**:

1. 複雑フォームを持つ企業を選択
2. 送信を実行
3. 各フィールドの入力内容を確認

**期待結果**:

- ✅ ふりがながひらがな/カタカナで正しく入力される
- ✅ 郵便番号、都道府県、住所が正しく入力される
- ✅ 電話番号がハイフン付きで入力される
- ✅ メールアドレス確認用フィールドにも入力される

### 3.3 確認画面ありフォーム

**テスト対象**: 確認画面→最終送信の2段階フォーム

**テスト手順**:

1. 確認画面のある企業を選択
2. 送信を実行
3. 確認画面の検出と最終送信を確認

**期待結果**:

- ✅ 確認ボタンが検出される
- ✅ 確認ボタンがクリックされる
- ✅ MutationObserverで最終送信ボタンを検出
- ✅ 最終送信ボタンがクリックされる
- ✅ サンクスページへ遷移

### 3.4 その他パターンのフォーム

**テスト対象**: `/contact/other/`などの特殊なURL構造

**テスト手順**:

1. `/contact-other/`のような企業を選択
2. フォーム検出を確認

**期待結果**:

- ✅ ハイフン区切り(`/contact-other/`)が検出される
- ✅ アンダーバー区切り(`/contact_other/`)が検出される
- ✅ 通常の`/contact/`も検出される

---

## 4. 送信結果管理テスト

### 4.1 リード表への反映

**テスト手順**:

1. 5件のリードを送信
2. すべての処理が完了するまで待つ
3. 実行ログで「✅ リード表更新完了」を確認
4. リード一覧を確認

**期待結果**:

- ✅ 送信結果が「未送信」→「成功」「失敗」に変更
- ✅ 送信回数が1になる
- ✅ 最終送信日が今日の日付になる
- ✅ エラーメッセージが保存される（失敗時）

### 4.2 途中でキューを追加

**テスト手順**:

1. 5件のリードを送信（送信A）
2. 3件完了、2件処理中の状態で、さらに5件を送信（送信B）
3. すべてのキューが完了するまで待つ

**期待結果**:

- ✅ 送信Aの残り2件が完了後、送信Bの5件が処理される
- ✅ 合計10件が全て完了した後、リード表が一括更新される
- ✅ 途中での部分更新は行われない

### 4.3 フィルタリング

**テスト手順**:

1. 送信結果列のフィルターを開く
2. 各ステータスを選択

**期待結果**:

- ✅ 「未送信」でフィルタすると未送信のみ表示
- ✅ 「成功」でフィルタすると成功のみ表示
- ✅ 「失敗」でフィルタすると失敗のみ表示
- ✅ 「送信不可」でフィルタすると送信不可のみ表示

---

## 5. Chrome拡張機能キュー管理テスト

### 5.1 Popupの表示

**テスト手順**:

1. Chrome右上の拡張機能アイコンをクリック
2. Popupが開くことを確認
3. 統計情報が表示されることを確認

**期待結果**:

- ✅ 待機中、処理中、成功、失敗の4つのカードが表示
- ✅ 並行タブ数が表示される
- ✅ キューリストに各企業が表示される

### 5.2 リアルタイム更新

**テスト手順**:

1. 送信を開始
2. Popupを開いたままにする
3. 統計情報が自動更新されるか確認

**期待結果**:

- ✅ 2秒ごとに自動更新される
- ✅ 処理中のアイコンが回転する
- ✅ 待機/処理中/成功/失敗の件数が変化する

### 5.3 ログ削除

**テスト手順**:

1. すべての送信が完了（待機=0、処理中=0）
2. 「キューと失敗ログを削除」ボタンをクリック
3. モーダルダイアログで確認
4. 「削除する」をクリック

**期待結果**:

- ✅ モーダルダイアログが表示される
- ✅ 成功と失敗の件数が表示される
- ✅ 削除後、Popupから成功・失敗のログが消える
- ✅ リード表のデータは残っている

### 5.4 送信中のログ削除

**テスト手順**:

1. 送信を開始（待機または処理中が1以上）
2. 削除ボタンを確認

**期待結果**:

- ✅ 削除ボタンが無効化されている（グレーアウト）
- ✅ ホバー時に「送信中は削除できません」と表示される

---

## 6. エラーハンドリングテスト

### 6.1 Content Script重複実行エラー

**テスト手順**:

1. 同じページで複数回拡張機能を再読み込み
2. DevToolsコンソールでエラーを確認

**期待結果**:

- ✅ 「Already loaded, skipping re-initialization」と表示
- ✅ 「Identifier 'O' has already been declared」エラーが発生しない

### 6.2 DOM Exception エラー

**テスト手順**:

1. 特殊なID/セレクタを持つフォームで送信
2. エラーログを確認

**期待結果**:

- ✅ 不正なセレクタでもエラーが発生しない
- ✅ DOMExceptionが適切にキャッチされる
- ✅ 詳細なエラーメッセージがログに記録される

---

## パフォーマンステスト結果

| 並行数 | 件数  | 処理時間 | 成功率 | 備考      |
| ------ | ----- | -------- | ------ | --------- |
| 1並行  | 10件  | 15分     | 80%    | 標準速度  |
| 3並行  | 10件  | 5分      | 80%    | 3倍高速化 |
| 5並行  | 10件  | 3分      | 80%    | 5倍高速化 |
| 3並行  | 100件 | 50分     | 75%    | 推奨設定  |
| 5並行  | 100件 | 30分     | 75%    | 高速処理  |

---

## セキュリティテスト

### 権限チェック

- [ ] `<all_urls>` 権限が適切に使用されている
- [ ] 不要なサイトにアクセスしていない
- [ ] ユーザーデータが適切に保護されている

### CORS設定

- [ ] `externally_connectable`で許可されたオリジンのみ接続可能
- [ ] 未許可のオリジンからの接続は拒否される

---

## 既知の問題

| 問題                                           | 影響度 | 対処法       | ステータス |
| ---------------------------------------------- | ------ | ------------ | ---------- |
| 一部サイトでフォーム未検出                     | Medium | 手動送信     | Open       |
| 外部フォームサービス（Googleフォーム等）非対応 | Low    | 対応予定なし | Won't Fix  |
| CAPTCHAのあるフォームは送信不可                | Low    | 手動送信     | Open       |
