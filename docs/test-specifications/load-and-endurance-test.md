# 負荷テスト・耐久テスト仕様書

## 1. テスト概要

### 1.1 目的

- システムの性能限界を把握する
- 想定される負荷下での安定性を検証する
- ボトルネックとなる箇所を特定する
- 長時間稼働時の安定性を確認する

### 1.2 対象システム

- **アプリケーション**: Apotto（PDF配信・閲覧追跡・AI営業支援システム）
- **構成**:
  - Next.js 16（フロントエンド + API Routes）
  - Supabase（PostgreSQL）
  - Railway Worker（Playwright自動送信）
  - Vercel（デプロイ環境）

### 1.3 テストツール

- **負荷テスト**: k6, Apache JMeter, Artillery
- **モニタリング**: Vercel Analytics, Supabase Metrics
- **APM**: New Relic / Datadog（推奨）

### 1.4 テストケースの構成

各テストケースは以下の情報を含みます：

| 項目             | 説明                             |
| ---------------- | -------------------------------- |
| **対象画面**     | テスト対象の画面名とURL          |
| **機能**         | テスト対象の機能の説明           |
| **テスト内容**   | 何をテストするのか（負荷条件）   |
| **期待する動作** | 負荷をかけた状態で期待される動作 |

**テストケースID命名規則**:

- `TC-L-[連番]`: 負荷テスト (Load Test)
- `TE-[連番]`: 耐久テスト (Endurance Test)
- `TS-[連番]`: スパイクテスト (Spike Test)

---

## 2. 負荷テスト

### 2.1 想定ユーザー数と負荷パターン

#### 通常運用想定

- **同時アクティブユーザー**: 50名
- **ピーク時同時接続**: 100名
- **1日あたりPDF送信**: 500件
- **1日あたりPDF閲覧**: 1,000件

#### テストシナリオ

| シナリオ     | 同時ユーザー | 持続時間 | 目的                   |
| ------------ | ------------ | -------- | ---------------------- |
| ベースライン | 10           | 5分      | 基準性能測定           |
| 通常負荷     | 50           | 15分     | 通常運用時の性能       |
| ピーク負荷   | 100          | 15分     | ピーク時の性能         |
| ストレス     | 200          | 10分     | 限界点の特定           |
| スパイク     | 50→300→50    | 15分     | 急激な負荷変動への対応 |

---

### 2.2 テストケース

#### 2.2.1 認証・セッション管理

**TC-L001: ログイン処理の負荷テスト**

| 項目             | 内容                                                                       |
| ---------------- | -------------------------------------------------------------------------- |
| **対象画面**     | ログイン画面 (`/login`)                                                    |
| **機能**         | メールアドレスとパスワードでログイン                                       |
| **テスト内容**   | 大量の同時ログインリクエストを処理できること                               |
| **期待する動作** | 100名が同時にログインしても、各ユーザーが500ms以内にログイン完了できること |

```yaml
目的: 同時ログイン処理の性能を測定
エンドポイント: POST /api/auth/login
負荷パターン:
  - 同時ユーザー: 10 → 50 → 100 (段階的)
  - リクエストレート: 10 req/sec → 50 req/sec
  - 持続時間: 各段階5分
期待値:
  - レスポンスタイム: p95 < 500ms
  - エラー率: < 1%
  - スループット: > 40 req/sec
```

---

**TC-L002: セッション維持の負荷テスト**

| 項目             | 内容                                                                |
| ---------------- | ------------------------------------------------------------------- |
| **対象画面**     | 全画面（共通）                                                      |
| **機能**         | ログイン状態の維持・セッション管理                                  |
| **テスト内容**   | 多数のユーザーが同時にアクティブでも正常に動作すること              |
| **期待する動作** | 100名が同時に操作していても、セッションが切断されずに継続できること |

```yaml
目的: 多数のアクティブセッション維持時の性能
シナリオ:
  - 100セッションを同時に維持
  - 各セッションで2分ごとにAPI呼び出し
  - 持続時間: 30分
期待値:
  - セッション切断率: < 0.1%
  - レスポンスタイム: p95 < 1000ms
```

---

#### 2.2.2 PDF管理

**TC-L003: PDF一覧取得の負荷テスト**

| 項目             | 内容                                                           |
| ---------------- | -------------------------------------------------------------- |
| **対象画面**     | PDF管理画面 (`/pdf-assets`)                                    |
| **機能**         | アップロード済みPDFの一覧表示                                  |
| **テスト内容**   | 大量のPDFを持つ多数のユーザーが同時にアクセスできること        |
| **期待する動作** | 50名が同時にPDF一覧を表示しても、800ms以内に全件表示できること |

```yaml
目的: PDF一覧API の性能測定
エンドポイント: GET /api/pdf/list
負荷パターン:
  - 同時ユーザー: 50
  - リクエストレート: 20 req/sec
  - 持続時間: 10分
データ条件:
  - 企業あたりPDF: 50〜200件
期待値:
  - レスポンスタイム: p95 < 800ms
  - エラー率: < 0.5%
```

---

**TC-L004: PDFアップロードの負荷テスト**

| 項目             | 内容                                                                |
| ---------------- | ------------------------------------------------------------------- |
| **対象画面**     | PDF管理画面 (`/pdf-assets`)                                         |
| **機能**         | PDFファイルのアップロード                                           |
| **テスト内容**   | 複数ユーザーが同時に大容量PDFをアップロードできること               |
| **期待する動作** | 10名が同時に10MBのPDFをアップロードしても、失敗せずに完了できること |

```yaml
目的: 同時アップロード処理の性能
エンドポイント: POST /api/pdf/upload
負荷パターン:
  - 同時ユーザー: 10
  - ファイルサイズ: 1MB〜10MB (混在)
  - 並行アップロード: 10件/分
  - 持続時間: 15分
期待値:
  - アップロード成功率: > 99%
  - レスポンスタイム: p95 < 5000ms (5MB時)
  - Storage容量チェック: 正常動作
```

---

#### 2.2.3 PDF閲覧・トラッキング

**TC-L005: PDF閲覧開始（トークン検証）の負荷テスト**

| 項目             | 内容                                                                               |
| ---------------- | ---------------------------------------------------------------------------------- |
| **対象画面**     | PDF閲覧画面 (`/pdf/[token]`)                                                       |
| **機能**         | メールアドレス入力後のPDF閲覧開始                                                  |
| **テスト内容**   | 多数の閲覧者が同時にPDFアクセスを開始できること                                    |
| **期待する動作** | 50名が同時にメールアドレスを入力してPDF閲覧を開始しても、600ms以内に表示できること |

```yaml
目的: PDF閲覧開始処理の性能
エンドポイント: POST /api/pdf/[token]/open
負荷パターン:
  - 同時閲覧開始: 50
  - リクエストレート: 30 req/sec
  - 持続時間: 10分
期待値:
  - レスポンスタイム: p95 < 600ms
  - エラー率: < 0.5%
  - DB書き込み遅延: < 100ms
```

---

**TC-L006: 閲覧進捗更新の負荷テスト**

| 項目             | 内容                                                                      |
| ---------------- | ------------------------------------------------------------------------- |
| **対象画面**     | PDF閲覧画面 (`/pdf/[token]`)                                              |
| **機能**         | PDF閲覧中の進捗・スクロール位置の記録                                     |
| **テスト内容**   | 多数の閲覧者のスクロール・閲覧時間を同時に記録できること                  |
| **期待する動作** | 100名が同時にPDFを閲覧して5秒ごとに進捗を送信しても、正常に記録できること |

```yaml
目的: 大量の進捗更新リクエスト処理
エンドポイント: POST /api/pdf/[token]/progress
負荷パターン:
  - 同時閲覧者: 100
  - 更新頻度: 5秒ごと (各ユーザー)
  - 持続時間: 30分
期待値:
  - レスポンスタイム: p95 < 300ms
  - エラー率: < 1%
  - DB負荷: CPU < 70%
```

---

**TC-L007: PDF閲覧ページの同時アクセス**

| 項目             | 内容                                                                   |
| ---------------- | ---------------------------------------------------------------------- |
| **対象画面**     | PDF閲覧画面 (`/pdf/[token]`)                                           |
| **機能**         | PDFの表示・閲覧                                                        |
| **テスト内容**   | 大量のユーザーが同時にPDFを閲覧できること                              |
| **期待する動作** | 200名が同時にPDFを閲覧しても、各ユーザーが2秒以内にPDFを表示できること |

```yaml
目的: 実際のPDF閲覧ページへの負荷
エンドポイント: GET /pdf/[token]
負荷パターン:
  - 同時閲覧: 200
  - 新規閲覧開始: 10件/分
  - 持続時間: 20分
期待値:
  - 初回表示: p95 < 2000ms
  - PDF読み込み: p95 < 3000ms
  - エラー率: < 0.5%
```

---

#### 2.2.4 AI文言生成

**TC-L008: AI文言生成（ストリーミング）の負荷テスト**

| 項目             | 内容                                                                   |
| ---------------- | ---------------------------------------------------------------------- |
| **対象画面**     | AIカスタム生成画面 (`/ai-custom`)                                      |
| **機能**         | 企業情報からAIで営業文を自動生成                                       |
| **テスト内容**   | 複数ユーザーが同時にAI文言生成を実行できること                         |
| **期待する動作** | 20名が同時にAI生成を開始しても、15秒以内に全員の文言が生成完了すること |

```yaml
目的: OpenAI API呼び出しの性能と並列処理
エンドポイント: POST /api/ai/sales-copy/stream
負荷パターン:
  - 同時生成: 5 → 10 → 20 (段階的)
  - 持続時間: 各段階5分
  - リトライ含む
期待値:
  - 生成開始時間: p95 < 2000ms
  - 生成完了時間: p95 < 15000ms
  - エラー率: < 2%
  - タイムアウト処理: 正常動作
制約:
  - OpenAI API Rate Limit考慮
  - 同時実行数制限（Max 3）
```

---

#### 2.2.5 フォーム自動送信

**TC-L009: バッチ送信処理の負荷テスト**

| 項目             | 内容                                                            |
| ---------------- | --------------------------------------------------------------- |
| **対象画面**     | AIカスタム生成画面 (`/ai-custom`)                               |
| **機能**         | 選択した企業に対してフォーム自動送信                            |
| **テスト内容**   | 大量の企業に対して同時に自動送信できること                      |
| **期待する動作** | 100件の企業を選択して送信しても、すべて正常に処理が完了すること |

```yaml
目的: Railway Worker への負荷と処理能力
エンドポイント: POST /api/auto-submit/batch
負荷パターン:
  - バッチサイズ: 10件 → 50件 → 100件
  - 同時バッチ: 3件
  - 持続時間: 各段階10分
期待値:
  - バッチ受付: p95 < 1000ms
  - 処理完了時間: 平均 5秒/件
  - エラー率: < 5% (CAPTCHA除外)
  - Worker再起動回数: 0回
```

---

**TC-L010: Railway Worker の耐久性テスト**

| 項目             | 内容                                                           |
| ---------------- | -------------------------------------------------------------- |
| **対象画面**     | AIカスタム生成画面 (`/ai-custom`)                              |
| **機能**         | フォーム自動送信の長時間稼働                                   |
| **テスト内容**   | 長時間連続で自動送信しても安定動作すること                     |
| **期待する動作** | 500件の連続送信（2時間）でもメモリリークやクラッシュがないこと |

```yaml
目的: 長時間稼働時の安定性
負荷パターン:
  - 連続送信: 500件
  - 送信間隔: 10秒
  - 持続時間: 2時間
監視項目:
  - メモリリーク: なし
  - CPU使用率: < 80%
  - プロセスクラッシュ: 0回
  - タイムアウトエラー: < 3%
```

---

#### 2.2.6 ダッシュボード・分析

**TC-L011: ダッシュボードメトリクス取得の負荷テスト**

| 項目             | 内容                                                                      |
| ---------------- | ------------------------------------------------------------------------- |
| **対象画面**     | データ分析画面 (`/dashboard`)                                             |
| **機能**         | PDF閲覧状況・インテントスコアの表示                                       |
| **テスト内容**   | 大量のデータを集計・表示しても高速に動作すること                          |
| **期待する動作** | 30名が同時にダッシュボードを開いても、3秒以内にグラフ・表が表示されること |

```yaml
目的: 複雑な集計クエリの性能
エンドポイント: GET /api/dashboard/metrics
負荷パターン:
  - 同時ユーザー: 30
  - フィルタ条件: 7日/30日/90日 混在
  - リクエストレート: 10 req/sec
  - 持続時間: 10分
データ条件:
  - 送信ログ: 10,000件
  - 開封イベント: 50,000件
期待値:
  - レスポンスタイム: p95 < 3000ms
  - エラー率: < 1%
  - DB CPU: < 80%
```

---

**TC-L012: リード管理（AgGrid）の負荷テスト**

| 項目             | 内容                                                                     |
| ---------------- | ------------------------------------------------------------------------ |
| **対象画面**     | AIカスタム生成画面 (`/ai-custom`)                                        |
| **機能**         | リード情報の一覧表示・編集                                               |
| **テスト内容**   | 大量のリードを表示・編集しても快適に操作できること                       |
| **期待する動作** | 5,000件のリードを表示し、20名が同時に編集しても、2秒以内に反映されること |

```yaml
目的: 大量データの取得・編集性能
エンドポイント:
  - GET /api/leads (一覧)
  - PATCH /api/leads/[id] (更新)
負荷パターン:
  - 同時ユーザー: 20
  - データ件数: 5,000件/企業
  - 更新頻度: 10件/分
  - 持続時間: 15分
期待値:
  - 一覧取得: p95 < 2000ms
  - 更新: p95 < 500ms
  - エラー率: < 0.5%
```

---

#### 2.2.7 メンテナンス処理

**TC-L013: クリーンアップ処理の性能テスト**

| 項目             | 内容                                                                             |
| ---------------- | -------------------------------------------------------------------------------- |
| **対象画面**     | なし（バックグラウンド処理）                                                     |
| **機能**         | 古いデータの自動削除・失効処理                                                   |
| **テスト内容**   | 大量の古いデータを削除しても他の処理に影響しないこと                             |
| **期待する動作** | 10万件の古いログを削除しても、60秒以内に完了し、他のユーザー操作に影響がないこと |

```yaml
目的: 定期メンテナンス処理の性能確認
エンドポイント: POST /api/maintenance/cleanup
負荷パターン:
  - 単発実行（手動トリガー）
  - データ規模: 100,000件の送信ログ
期待値:
  - 処理完了時間: < 60秒
  - DB ロック時間: 最小化
  - エラー率: 0%
  - 他APIへの影響: なし
```

---

## 3. 耐久テスト（Endurance Test）

### 3.1 テスト目的

- 長期間稼働時のメモリリーク検出
- リソース枯渇の確認
- 定期処理（cleanup）の影響確認

### 3.2 テストシナリオ

#### TE-001: 24時間耐久テスト

| 項目             | 内容                                                                                              |
| ---------------- | ------------------------------------------------------------------------------------------------- |
| **対象画面**     | 全画面                                                                                            |
| **機能**         | 全機能の長時間稼働                                                                                |
| **テスト内容**   | 24時間連続稼働しても性能劣化しないこと                                                            |
| **期待する動作** | ログイン、PDF閲覧、AI生成、ダッシュボードを24時間使い続けてもメモリリークやエラーが発生しないこと |

```yaml
目的: 通常負荷での長時間稼働
負荷パターン:
  - 同時ユーザー: 30〜50 (変動)
  - 混合シナリオ:
      - ログイン/ログアウト
      - PDF閲覧 (10分〜30分/セッション)
      - AI文言生成 (1回/時間)
      - ダッシュボード閲覧 (5分ごと)
  - 持続時間: 24時間
監視項目:
  - メモリ使用量推移
  - DB接続プール枯渇
  - エラーログ蓄積
  - レスポンスタイム劣化
期待値:
  - メモリ使用量: 安定（増加率 < 1%/時間）
  - エラー率: < 0.5%
  - レスポンスタイム: 劣化なし
```

---

#### TE-002: 週末耐久テスト（72時間）

| 項目             | 内容                                                               |
| ---------------- | ------------------------------------------------------------------ |
| **対象画面**     | PDF閲覧画面 (`/pdf/[token]`)                                       |
| **機能**         | PDF閲覧の長期稼働                                                  |
| **テスト内容**   | 週末など長期間ユーザーがいない状態でも安定すること                 |
| **期待する動作** | 72時間低負荷で稼働し続けても、サービス停止やエラーが発生しないこと |

```yaml
目的: 長期休暇中の安定性確認
負荷パターン:
  - 低負荷: 同時ユーザー 5〜10
  - PDF閲覧のみ継続
  - 持続時間: 72時間
監視項目:
  - セッションタイムアウト
  - DB接続維持
  - Vercel Function タイムアウト
期待値:
  - サービス停止: 0回
  - エラー率: < 0.1%
```

---

## 4. スパイクテスト

### 4.1 メール配信後のアクセス急増

#### TS-001: 一斉メール配信後のPDF閲覧スパイク

| 項目             | 内容                                                                                      |
| ---------------- | ----------------------------------------------------------------------------------------- |
| **対象画面**     | PDF閲覧画面 (`/pdf/[token]`)                                                              |
| **機能**         | PDF閲覧の急激なアクセス増加                                                               |
| **テスト内容**   | メール一斉配信後の急激なアクセス増加に耐えられること                                      |
| **期待する動作** | 500名にメール配信後、10分以内に200名が同時アクセスしても、全員が正常にPDFを閲覧できること |

```yaml
目的: 同時刻に大量のPDF閲覧が発生する状況
シナリオ:
  - 500名への一斉メール配信を想定
  - 10分以内に200名が閲覧開始
  - その後30分で残り100名が閲覧
負荷パターン:
  - 0〜10分: 200 req/min
  - 10〜40分: 50 req/min
  - 40〜60分: 10 req/min
期待値:
  - 閲覧開始エラー: < 1%
  - Vercel Function スケール: 正常動作
  - DB接続プール: 正常動作
```

---

## 5. パフォーマンス基準

### 5.1 レスポンスタイム目標

| エンドポイント分類 | p50    | p95    | p99    | Max     |
| ------------------ | ------ | ------ | ------ | ------- |
| 認証               | 200ms  | 500ms  | 1000ms | 2000ms  |
| PDF一覧・詳細      | 300ms  | 800ms  | 1500ms | 3000ms  |
| PDFアップロード    | 1000ms | 5000ms | 8000ms | 15000ms |
| 閲覧トラッキング   | 100ms  | 300ms  | 600ms  | 1000ms  |
| AI生成（開始）     | 500ms  | 2000ms | 3000ms | 5000ms  |
| ダッシュボード     | 800ms  | 3000ms | 5000ms | 8000ms  |
| リード更新         | 200ms  | 500ms  | 1000ms | 2000ms  |

### 5.2 可用性目標

- **稼働率**: 99.5% (月間ダウンタイム < 3.6時間)
- **エラー率**: < 1%
- **データ損失**: 0件

---

## 6. 負荷テスト実施手順

### 6.1 事前準備

1. **テスト環境準備**

   ```bash
   # ステージング環境を本番相当のスペックで構築
   # Supabase: Proプラン以上推奨
   # Vercel: Proプラン以上推奨
   ```

2. **テストデータ準備**

   ```sql
   -- 企業: 100社
   -- PDF: 50〜200件/企業 = 合計10,000件
   -- 送信ログ: 100,000件
   -- 開封イベント: 50,000件
   -- リード: 5,000件/企業
   ```

3. **モニタリングセットアップ**
   - Vercel Analyticsダッシュボード準備
   - Supabase メトリクスダッシュボード準備
   - ログ収集設定（Datadog / CloudWatch）

### 6.2 テスト実行

```bash
# k6 負荷テストスクリプト例
k6 run --vus 50 --duration 15m \
  --out json=results.json \
  scripts/load-test-pdf-view.js

# Artillery スパイクテスト例
artillery run --output report.json \
  scenarios/spike-test-email-blast.yml
```

### 6.3 テスト後の確認

1. **結果分析**
   - レスポンスタイム分布
   - エラーログ確認
   - リソース使用率推移

2. **ボトルネック特定**
   - DB クエリ最適化
   - API レート制限調整
   - キャッシュ戦略見直し

3. **改善策実施**
   - インデックス追加
   - Connection Pool チューニング
   - CDN キャッシュ設定

---

## 7. 合格基準

### 7.1 必須条件

- [ ] 全テストケースでエラー率 < 5%
- [ ] p95 レスポンスタイムが目標値内
- [ ] 24時間耐久テストで重大障害なし
- [ ] メモリリークなし
- [ ] データ整合性維持

### 7.2 推奨条件

- [ ] p99 レスポンスタイムが目標値内
- [ ] スパイクテストでの自動スケール成功
- [ ] 72時間耐久テストで性能劣化なし

---

## 8. リスクと対策

| リスク                       | 影響度 | 対策                   |
| ---------------------------- | ------ | ---------------------- |
| OpenAI API Rate Limit        | 高     | リトライ・Queue実装    |
| Supabase 接続数枯渇          | 高     | Connection Pool 最適化 |
| Vercel Function タイムアウト | 中     | 長時間処理の分割       |
| Railway Worker クラッシュ    | 中     | エラーハンドリング強化 |
| Storage 容量不足             | 低     | 定期クリーンアップ     |

---

## 9. 付録

### 9.1 k6 サンプルスクリプト

```javascript
// scripts/load-test-pdf-view.js
import http from "k6/http";
import { check, sleep } from "k6";

export let options = {
  stages: [
    { duration: "2m", target: 10 },
    { duration: "5m", target: 50 },
    { duration: "5m", target: 100 },
    { duration: "2m", target: 0 },
  ],
  thresholds: {
    http_req_duration: ["p(95)<800"],
    http_req_failed: ["rate<0.01"],
  },
};

export default function () {
  // ログイン
  let loginRes = http.post("https://app.example.com/api/auth/login", {
    email: "test@example.com",
    password: "password",
  });
  check(loginRes, { "login success": (r) => r.status === 200 });

  sleep(1);

  // PDF一覧取得
  let listRes = http.get("https://app.example.com/api/pdf/list");
  check(listRes, { "list success": (r) => r.status === 200 });

  sleep(2);

  // PDF閲覧開始
  let openRes = http.post("https://app.example.com/api/pdf/test-token/open", {
    email: "viewer@example.com",
  });
  check(openRes, { "open success": (r) => r.status === 200 });

  sleep(5);
}
```

### 9.2 Artillery サンプルシナリオ

```yaml
# scenarios/spike-test-email-blast.yml
config:
  target: "https://app.example.com"
  phases:
    - duration: 60
      arrivalRate: 5
      name: "Warm up"
    - duration: 120
      arrivalRate: 100
      name: "Spike"
    - duration: 300
      arrivalRate: 10
      name: "Cool down"
  http:
    timeout: 30

scenarios:
  - name: "PDF viewing after email blast"
    flow:
      - post:
          url: "/api/pdf/{{ token }}/open"
          json:
            email: "{{ $randomEmail }}"
      - think: 3
      - post:
          url: "/api/pdf/{{ token }}/progress"
          json:
            readPercentage: 50
            elapsedSeconds: 30
      - think: 30
```

---

## 変更履歴

| 日付       | バージョン | 変更内容 | 担当者 |
| ---------- | ---------- | -------- | ------ |
| 2026-01-03 | 1.0        | 初版作成 | -      |
