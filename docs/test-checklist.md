# テストチェックリスト

最終更新: 2026-02-06

## 📋 概要

本番環境デプロイ前、および機能追加・修正後に実施すべきテスト項目の一覧。

---

## ✅ テスト実施ステータス

| カテゴリ                  | 実施日     | 結果                        | 担当者 |
| ------------------------- | ---------- | --------------------------- | ------ |
| 1. 認証・セッション       | -          | -                           | -      |
| 2. リード管理             | -          | -                           | -      |
| 3. AI機能                 | -          | -                           | -      |
| 4. 自動送信（Chrome拡張） | 2026-02-06 | ✅ Chrome拡張機能に移行完了 | -      |
| 5. PDF管理                | -          | -                           | -      |
| 6. 決済・サブスク         | -          | -                           | -      |
| 7. パフォーマンス         | -          | -                           | -      |
| 8. セキュリティ           | -          | -                           | -      |

---

## 1️⃣ 認証・セッション管理

### ログイン・ログアウト

- [ ] **正常ログイン**
  - メールアドレス・パスワードで正常にログインできる
  - ダッシュボードにリダイレクトされる
  - セッションが正しく作成される

- [ ] **初回ログイン**
  - 招待されたアカウントが初回ログインできる
  - パスワード設定画面が表示される
  - ステータスが `invited` → `active` になる

- [ ] **ログイン失敗**
  - 誤ったパスワードでエラーメッセージが表示される
  - 存在しないメールアドレスでエラーになる
  - 3回失敗後にロックアウトされる（未実装の場合はスキップ）

- [ ] **同時ログイン制限**
  - 別デバイスでログイン後、元のデバイスでセッション無効エラー
  - 無効セッションで `/api/*` にアクセスすると401エラー
  - 再ログインで正常に復帰

- [ ] **ログアウト**
  - ログアウト後にダッシュボードにアクセスするとログイン画面へ
  - セッションが正しく削除される
  - Cookieがクリアされる

### セッション有効期限

- [ ] **セッション維持**
  - 1時間以内のアクティビティでセッションが維持される
  - ページ遷移でセッションが切れない

- [ ] **セッション期限切れ**
  - 長時間放置後（設定時間経過後）にログアウトされる
  - 期限切れ後のAPI呼び出しで401エラー

---

## 2️⃣ リード管理

### CSVインポート

- [ ] **正常インポート（小規模）**
  - 10件のCSVファイルをインポート
  - 全件正常に取り込まれる
  - 重複チェックが機能する

- [ ] **正常インポート（中規模）**
  - 100件のCSVファイルをインポート
  - パフォーマンス問題がない（5秒以内）
  - メモリエラーが発生しない

- [ ] **正常インポート（大規模）**
  - 1,000件のCSVファイルをインポート
  - タイムアウトしない
  - データベース負荷が許容範囲

- [ ] **CSV形式エラー**
  - 不正な形式のCSVでエラーメッセージ表示
  - 必須項目が欠けているとエラー
  - 文字化けCSVで適切なエラーハンドリング

- [ ] **重複インポート**
  - 既存URLと同じリードをインポート
  - 重複件数が正しく表示される
  - 新規分のみが追加される

### リード一覧表示

- [ ] **一覧取得（ページネーション）**
  - 100件のリードを10件ずつページング表示
  - ページ遷移が正常に動作
  - ソート機能が動作（作成日、会社名など）

- [ ] **フィルタリング**
  - 送信ステータスでフィルタ（pending/success/failed）
  - 会社名で検索
  - 日付範囲で絞り込み

- [ ] **Intent Score計算**
  - PDF送信後、開封までの時間でスコア計算
  - 24時間以内 → 90点（High）
  - 72時間以内 → 60点（Medium）
  - それ以降 → 30点（Low）
  - 未開封 → 0点

### リード編集・削除

- [ ] **個別編集**
  - リード情報を編集して保存
  - 変更が正しく反映される

- [ ] **一括削除**
  - 複数選択して一括削除
  - 確認ダイアログが表示される
  - 削除後にリストから消える

---

## 3️⃣ AI機能

### 営業メール生成

- [ ] **基本生成（最小限の情報）**
  - 送信者情報のみで生成
  - 件名・本文が生成される
  - プレースホルダーが残っていない

- [ ] **完全情報での生成**
  - 送信者・受信者・クローリング結果すべて含む
  - 具体的な企業情報が盛り込まれる
  - 適切な敬語・トーンで生成

- [ ] **添付PDF付き生成**
  - PDFのURLが本文に含まれる
  - `{{PDF_LINK_1}}` などのプレースホルダーが正しく挿入

- [ ] **商談URL付き生成**
  - `meetingUrl` が本文に含まれる
  - 適切な導入文で記載される

- [ ] **生成エラーハンドリング**
  - OpenAI APIエラー時にフォールバック
  - タイムアウト時に適切なエラーメッセージ

- [ ] **ストリーミング生成**
  - `/api/ai/sales-copy/stream` でリアルタイム表示
  - 途中でキャンセル可能
  - エラー時も適切にストリーム終了

### チャットボット

- [ ] **基本的な質問応答**
  - サービスに関する質問に回答
  - ナレッジベースの情報を参照

- [ ] **コンテキスト保持**
  - 会話履歴を保持
  - 前の質問を踏まえた回答

- [ ] **エラーハンドリング**
  - 不適切な質問に対する対応
  - APIエラー時のフォールバック

---

## 4️⃣ 自動送信機能（Chrome拡張機能）

**詳細なテスト仕様**: [chrome-extension-test.md](./test-specifications/chrome-extension-test.md)を参照

### Chrome拡張機能の接続

- [ ] **拡張機能接続確認**
  - 「✓ Chrome拡張機能に接続中」と表示される
  - 拡張機能Popupが開く

### 並行処理

- [ ] **並行タブ数の設定**
  - 1-5並行から選択可能
  - 選択した並行数で処理される

### 単一送信

- [ ] **正常送信（基本フォーム）**
  - 会社名、名前、メールアドレスのみ
  - フォーム検出・入力・送信成功
  - ログが正しく記録される

- [ ] **正常送信（複雑フォーム）**
  - 部署、役職、電話番号など全項目
  - ふりがなフィールドも正しく入力
  - 住所フィールド（郵便番号、都道府県など）も入力

- [ ] **iframe内フォーム**
  - iframe埋め込みフォームを検出
  - フォーム入力・送信成功

- [ ] **確認画面ありフォーム**
  - 確認画面が表示される
  - 最終送信ボタンをクリック
  - サンクスページへ遷移

- [ ] **送信失敗（フォーム未検出）**
  - フォームが存在しないページ
  - 適切なエラーメッセージ

- [ ] **送信失敗（CAPTCHA検出）**
  - reCAPTCHA/hCaptchaがある場合
  - "CAPTCHA detected" エラー

- [ ] **送信失敗（必須項目未入力）**
  - バリデーションエラーが表示される
  - エラーをログに記録

### 一括送信（Chrome拡張機能）

- [ ] **10件一括送信（1並行）**
  - 1件ずつ順次処理される
  - 実行ログに進捗が表示される
  - すべて完了後、リード表が更新される

- [ ] **10件一括送信（3並行）**
  - 最大3件が同時に処理される
  - 処理速度が約3倍になる
  - リード表が正しく更新される

- [ ] **100件一括送信（5並行）**
  - 全件処理が完了する
  - 送信回数が正しく記録される
  - 最終送信日が更新される
  - 処理時間が約30分以内

### 送信結果の管理

- [ ] **送信ステータスの記録**
  - 「未送信」→「成功」「失敗」「送信不可」に変更される
  - 送信回数がインクリメントされる
  - 最終送信日が記録される

- [ ] **エラーメッセージの保存**
  - 失敗時に詳細なエラーが保存される
  - リード表で確認できる

- [ ] **失敗企業の再送信**
  - 失敗した企業も再送信可能
  - 送信回数が増加する

### Chrome拡張機能のキュー管理

- [ ] **キュー状態の表示**
  - 待機/処理中/成功/失敗の件数が表示される
  - リアルタイムで更新される（2秒ごと）

- [ ] **ログ削除**
  - 送信完了後のみ削除可能
  - モーダルダイアログで確認
  - 成功・失敗のログが削除される

### パフォーマンス

- [ ] **1並行での処理速度**
  - 1件あたり1-2分
  - タイムアウトしない（最大2分/件）

- [ ] **3並行での処理速度**
  - 1並行の約3倍の速度
  - 100件で約50分

- [ ] **5並行での処理速度**
  - 1並行の約5倍の速度
  - 100件で約30分

---

## 5️⃣ PDF管理

### PDFアップロード

- [ ] **正常アップロード（小サイズ）**
  - 1MB以下のPDFをアップロード
  - メタデータが正しく保存される
  - Supabase Storageに保存される

- [ ] **正常アップロード（大サイズ）**
  - 10MBのPDFをアップロード
  - タイムアウトしない
  - アップロード進捗が表示される

- [ ] **サイズ制限**
  - 50MBを超えるファイルでエラー
  - 適切なエラーメッセージ

- [ ] **形式チェック**
  - PDF以外のファイル（Word、画像など）でエラー
  - MIMEタイプチェックが機能

- [ ] **重複チェック**
  - 同じファイルを再度アップロード
  - 重複検出（ハッシュ値比較）
  - 警告表示または自動スキップ

### PDF送信・トラッキング

- [ ] **PDFリンク生成**
  - 一意のトークン付きURLが生成される
  - リンクが営業メールに挿入される

- [ ] **PDF閲覧トラッキング**
  - リンクをクリックすると閲覧イベント記録
  - IP、User-Agent、参照元が記録される
  - 開封日時が正しく記録される

- [ ] **PDF表示**
  - ブラウザでPDFが表示される
  - ダウンロード可能
  - モバイルでも表示できる

- [ ] **無効トークン**
  - 存在しないトークンで404エラー
  - 削除されたPDFで410エラー

- [ ] **トークン有効期限**
  - 有効期限切れで403エラー（実装されている場合）
  - 適切なエラーメッセージ

### PDF一覧・削除

- [ ] **PDF一覧表示**
  - アップロードしたPDF一覧を表示
  - ページネーション動作
  - ソート・フィルタリング

- [ ] **PDF削除**
  - PDFを削除
  - Storageからも削除される
  - 送信ログは残る（論理削除）

- [ ] **PDF削除の影響**
  - 削除後、トラッキングリンクは無効化
  - 既存の送信ログには影響なし

---

## 6️⃣ 決済・サブスクリプション

### Stripe Checkout

- [ ] **新規契約（月額プラン）**
  - Stripe Checkoutページへ遷移
  - カード決済が完了
  - サブスクリプションが作成される
  - ダッシュボードに戻る

- [ ] **新規契約（年額プラン）**
  - 年額プランを選択
  - 正しい金額で課金される
  - 割引が適用される

- [ ] **決済失敗**
  - カード情報エラーで決済失敗
  - エラーメッセージが表示される
  - サブスクリプションは作成されない

- [ ] **トライアル期間**
  - トライアル期間中は課金されない
  - トライアル終了後に自動課金
  - ステータスが `trialing` → `active`

### サブスクリプション管理

- [ ] **プラン変更（アップグレード）**
  - 上位プランへ変更
  - 日割り計算が正しい
  - 即座に機能が利用可能

- [ ] **プラン変更（ダウングレード）**
  - 下位プランへ変更
  - 次回更新日から適用
  - 制限が正しく反映される

- [ ] **サブスク解約**
  - 解約リクエスト
  - 期間終了まで利用可能
  - 自動更新が停止

- [ ] **支払い失敗**
  - カード期限切れなどで失敗
  - メール通知が送信される
  - ステータスが `past_due` になる
  - 一定期間後にサービス停止

### Webhookイベント

- [ ] **checkout.session.completed**
  - 新規サブスクリプション作成
  - データベースに記録される

- [ ] **invoice.paid**
  - 支払い成功イベント受信
  - ステータスが `active` に更新

- [ ] **invoice.payment_failed**
  - 支払い失敗イベント受信
  - ステータスが `past_due` に更新
  - 通知送信

- [ ] **customer.subscription.deleted**
  - 解約イベント受信
  - ステータスが `canceled` に更新

---

## 7️⃣ パフォーマンステスト

### レスポンス時間

- [ ] **ダッシュボード読み込み**
  - 3秒以内に表示
  - 初回訪問でも5秒以内

- [ ] **リード一覧（100件）**
  - 2秒以内に表示
  - ページング遷移が1秒以内

- [ ] **AI生成（通常）**
  - 10秒以内に生成完了
  - ストリーミング時は即座に開始

- [ ] **PDF閲覧**
  - 2秒以内に表示開始
  - 10MBファイルでも10秒以内

### 負荷テスト

- [ ] **同時ログイン（10ユーザー）**
  - 全員が正常にログインできる
  - レスポンスタイムが許容範囲

- [ ] **同時バッチ送信（5ユーザー、各50件）**
  - 全処理が完了する
  - サーバーがダウンしない
  - メモリ使用量が許容範囲

- [ ] **大量リクエスト（APIレート制限）**
  - 1秒に100リクエストなど
  - レート制限が機能（実装済みの場合）
  - 429エラーが返る

### データベース

- [ ] **大量データ（10,000件リード）**
  - クエリが遅延しない
  - インデックスが効いている
  - ページング動作が正常

- [ ] **同時書き込み（Deadlock対策）**
  - 複数ユーザーが同時にリード追加
  - データの整合性が保たれる
  - トランザクション制御が正常

---

## 8️⃣ セキュリティテスト

### 認証・認可

- [ ] **未認証アクセス**
  - `/api/*` に未認証でアクセス → 401
  - `/dashboard` に未認証でアクセス → ログインへリダイレクト

- [ ] **権限チェック**
  - 他社のリードにアクセス → 403
  - 他社のPDFにアクセス → 403
  - Admin専用機能に一般ユーザーがアクセス → 403

- [ ] **セッション盗用対策**
  - CookieにHttpOnly、Secure、SameSite属性
  - CSRF対策（実装済みの場合）

### インジェクション対策

- [ ] **SQLインジェクション**
  - クエリパラメータに `'; DROP TABLE--` など
  - Supabase RLSで防御
  - エラーが発生しない

- [ ] **XSS（クロスサイトスクリプティング）**
  - `<script>alert('XSS')</script>` を入力
  - エスケープ処理が機能
  - スクリプトが実行されない

- [ ] **コマンドインジェクション**
  - URLフィールドに `; rm -rf /` など
  - バリデーションで弾かれる
  - Playwrightで実行されない

### SSRF対策

- [ ] **プライベートIP禁止**
  - `http://127.0.0.1` → エラー
  - `http://192.168.1.1` → エラー
  - `http://localhost` → エラー

- [ ] **内部サービス保護**
  - `http://metadata.google.internal` → エラー
  - AWSメタデータエンドポイント → エラー

### データ保護

- [ ] **機密情報のログ出力禁止**
  - パスワード、APIキーがログに出ない
  - エラーメッセージに機密情報が含まれない

- [ ] **ファイルアップロードセキュリティ**
  - 実行可能ファイル（.exe, .sh）をアップロード → 拒否
  - ファイル名にパストラバーサル（`../../etc/passwd`）→ サニタイズ

---

## 9️⃣ エラーハンドリング

### ネットワークエラー

- [ ] **API接続失敗**
  - OpenAI APIダウン → フォールバック
  - Supabaseダウン → 適切なエラーメッセージ

- [ ] **タイムアウト**
  - 長時間かかるリクエスト → タイムアウトエラー
  - ユーザーに通知

### データエラー

- [ ] **不正なデータ形式**
  - JSON不正 → 400エラー
  - 必須項目欠如 → バリデーションエラー

- [ ] **データベースエラー**
  - 一意制約違反 → 適切なエラーメッセージ
  - 外部キー制約違反 → エラーハンドリング

---

## 🔟 統合テスト（E2Eシナリオ）

### シナリオ1: 新規ユーザーの初回利用

1. [ ] 招待メールからアクセス
2. [ ] 初回ログイン（パスワード設定）
3. [ ] ダッシュボード表示
4. [ ] リードCSVをインポート（10件）
5. [ ] PDFをアップロード
6. [ ] AIで営業メール生成
7. [ ] 1件送信してステータス確認

### シナリオ2: 大量バッチ送信

1. [ ] ログイン
2. [ ] 100件のリードをCSVインポート
3. [ ] 全件選択してバッチ送信
4. [ ] 進捗をリアルタイム確認
5. [ ] 送信完了後、ステータス確認
6. [ ] 失敗した件のみ再送信

### シナリオ3: PDF送信〜開封追跡

1. [ ] ログイン
2. [ ] PDFをアップロード
3. [ ] AIで営業メール生成（PDF付き）
4. [ ] リード送信
5. [ ] 受信者がPDFリンクをクリック
6. [ ] 開封イベントが記録される
7. [ ] Intent Scoreが更新される

### シナリオ4: サブスク契約〜解約

1. [ ] アカウント作成
2. [ ] Stripe Checkoutで契約
3. [ ] 機能が利用可能に
4. [ ] プラン変更（アップグレード）
5. [ ] サブスク解約リクエスト
6. [ ] 期間終了まで利用可能
7. [ ] 期間終了後にアクセス制限

---

## 1️⃣1️⃣ モバイル・ブラウザ互換性

### ブラウザテスト

- [ ] **Chrome（最新版）**
  - 全機能が動作する

- [ ] **Safari（最新版）**
  - 全機能が動作する
  - Cookie設定が正常

- [ ] **Firefox（最新版）**
  - 全機能が動作する

- [ ] **Edge（最新版）**
  - 全機能が動作する

### モバイルテスト

- [ ] **iOS Safari**
  - レスポンシブデザインが正常
  - タッチ操作が正常
  - PDF閲覧が可能

- [ ] **Android Chrome**
  - レスポンシブデザインが正常
  - タッチ操作が正常
  - PDF閲覧が可能

---

## 1️⃣2️⃣ 監視・ログ

### ログ出力

- [ ] **エラーログ**
  - エラー発生時にログ出力
  - スタックトレースが記録される

- [ ] **アクセスログ**
  - API呼び出しがログに記録される
  - IPアドレス、User-Agentが記録

- [ ] **監査ログ**
  - 重要操作（削除、権限変更など）が記録される

### アラート

- [ ] **Slackアラート**
  - エラー発生時にSlack通知
  - 重要イベント（契約、解約）で通知

- [ ] **エラー監視**
  - Sentry等のエラー監視ツール（実装済みの場合）
  - エラー発生時に自動通知

---

## 🎯 優先度別テスト項目

### 🔴 最優先（Critical）

毎回必ずテストすべき項目：

1. ✅ ログイン・ログアウト
2. ✅ リードCSVインポート（10件、100件）
3. ✅ AI営業メール生成
4. ✅ 自動送信（単一、バッチ10件、バッチ100件）
5. ✅ PDFアップロード・閲覧
6. ✅ セッション管理・同時ログイン制限

### 🟡 高優先度（High）

定期的にテストすべき項目：

7. Stripe決済・サブスク管理
8. PDF開封トラッキング
9. Intent Score計算
10. バッチ送信エラーハンドリング
11. セキュリティ（認証・認可）

### 🟢 中優先度（Medium）

機能追加・修正時にテストすべき項目：

12. パフォーマンス（レスポンス時間）
13. 大量データ処理（1,000件以上）
14. ブラウザ互換性
15. モバイル対応

### 🔵 低優先度（Low）

余裕があればテストする項目：

16. エラーログの詳細確認
17. 各種エッジケース
18. 負荷テスト（同時接続）
19. Webhook詳細動作

---

## 📝 テスト実施の記録

### テンプレート

```markdown
## テスト実施日: YYYY-MM-DD

担当者: 〇〇

### テスト環境

- URL: https://...
- ブラウザ: Chrome 120
- デバイス: MacBook Pro

### 実施項目

- [x] ログイン・ログアウト → ✅ 正常
- [x] バッチ送信（100件） → ⚠️ 容量エラー（修正済み）
- [ ] PDF閲覧 → 未実施

### 発見された問題

1. バッチ送信で PayloadTooLargeError
   - 原因: express.json()のデフォルト制限（100KB）
   - 対応: 50MBに拡張 (commit: ac17be9)

### 次回対応

- PDF開封トラッキングの動作確認
- モバイル環境でのテスト
```

---

## 🔗 関連ドキュメント

- [単体テスト仕様](./test-specifications/unit-test-specification.md)
- [負荷・耐久テスト](./test-specifications/load-and-endurance-test.md)
- [運用マニュアル](./operations-manual.md)
- [セキュリティ推奨事項](./SECURITY_RECOMMENDATIONS.md)

---

## 📞 問題発生時の連絡先

- 開発者: 紙谷
- 代表: 高田
- Slack: #apotto-alerts
