# apotto 要件

最終更新: 2026-02-06

## 1. 全体像とアーキテクチャ

- プロダクト名は **apotto**。画面は「AIカスタム文面生成」と「管理ダッシュボード」の2構成に統一する。
- Supabase（spabase）を認証・DB・Storage・Queue として採用し、Next.js (App Router) は UI / API を担当する。
- PDF は Supabase Storage コンテナで管理し、閲覧イベントや PDF 反応データは Supabase DB に保存する。
- OpenAI へのプロンプトは自社情報 (`sender.*`) と相手企業情報 (`recipient.*`) を明確に分離した JSON で投げ、欠損値は `◯◯◯` を自動補完する。

---

## 2. 画面A: AIカスタム文面生成

### 2.1 入力UI

- セクションを「自社情報」「相手企業情報」「資料添付」「生成結果」に分割し、必須/任意を明示する。
- 自社情報は担当者名・部署・役職・会社名・メール・電話などをまとめて入力し、各生成文に共通適用。
- 相手企業カードでは会社名、担当者名、部署、役職、フォームURL（必須）、メール、備考を編集できる。
- フォーム必須項目は **ホームページ（問い合わせフォーム）URLのみ**。未入力時は保存/生成不可。他フィールドは未入力なら `◯◯◯` を挿入。
- UI 上で「こちらの会社情報」「送信先の担当者情報」を色分けし、混在しないようラベル・説明文・ツールチップを配置する。

### 2.2 Excel / CSV インポート

- `.xlsx / .xls / .csv` をドラッグ&ドロップまたはファイル選択で受け付ける。1 行目はヘッダー扱い、**最大 100 社** まで読み込み。
- 列仕様（左から順に 5 列、5列目のみ必須）:
  1. 相手担当者名
  2. 相手部署名
  3. 相手役職名
  4. 相手メールアドレス
  5. 相手企業のホームページ（問い合わせフォーム）URL
- アップロード完了後は自動的に AI 生成キューが上から順に起動する。読み込まれた行は即カード化し、右上チェックボックスを **初期 ON** で描画。
- 列欠損・101 行目以降・読み取り失敗時はエリア下に詳細なエラーを表示し、該当レコードはカード化しない。

### 2.3 生成キューとカード操作

- `useGenerationQueue`（新規フック）でエクセル読み込みイベントを監視し、Supabase Queue にジョブを投入する。進行状況はカードのステータス/スピナーで表示。
- カード右上のチェックボックスで送信対象を切り替える。ON のカードのみ一括送信に含め、OFF は完全除外。
- 生成文はカード内プレビュー＋モーダルで編集。送信者/相手のタグ付き構造を保ちつつ、`◯◯◯` などの補完語も上書き可能。
- 送信不可（URL 無効など）のカードはエラー理由を表示し、自動的に OFF へ切り替える。

### 2.4 プロンプト/生成品質

- `src/lib/openaiClient.ts` のプロンプトテンプレートを Sender / Recipient / Product Context / Target Site Summary / Attached PDFs で区切る。
- 文字数制限・段落構成（挨拶→背景→提案→CTA）をテンプレート側で指定し、中途半端なテキストを防ぐポストプロセス（句点締め/改行調整）を実装。
- 生成ログには sender と recipient を個別フィールドで保存し、UI も同じ構造で表示する。

### 2.5 PDF 添付とトラッキング URL

- Supabase Storage に登録済み PDF を一覧表示し、文面ごとに 1 つ以上選択可能。選択した PDF ごとにユニークなトラッキング URL を生成する。
- URL をクリックすると apotto の PDF 閲覧ページ（`/pdf/[token]`）へ遷移し、閲覧前にメールアドレス入力を要求する。
- 生成した URL と PDF/企業カード ID を Supabase DB に保存し、後続の閲覧ログと紐付ける。

### 2.6 Chrome拡張機能による自動送信

#### 送信方式

- フォーム送信は**Chrome拡張機能**を使用してブラウザから直接実行する。
- Playwrightワーカーは廃止（Chrome拡張機能に統一）。
- リード一覧から選択した企業に対して、AIが生成した文言を企業の問い合わせフォームに自動送信する。

#### 並行処理機能

- **並行タブ数の選択**: ユーザーが1-5並行から選択可能。
  - 1並行: 最も軽い（低スペックPC向け）
  - 3並行: 推奨（バランス型）
  - 5並行: 最も速い（高スペックPC向け）
- 選択した並行数に応じて、複数のブラウザタブで同時にフォーム送信処理を実行。
- 並行数は送信開始前にドロップダウンで選択（送信中は変更不可）。

#### 送信フロー

1. リード一覧から送信する企業を選択（チェックボックス）
2. 並行タブ数を設定（1-5から選択）
3. 「生成&送信」または「送信」ボタンをクリック
4. Chrome拡張機能のキューにアイテムを追加
5. 拡張機能が並行数の上限まで自動的に処理を開始
6. 各企業のサイトを開く → フォーム検出 → 入力 → 送信
7. すべての処理が完了すると、リード表に結果を自動反映

#### 送信ステータス

- **未送信**: まだ送信処理を実行していない
- **成功**: フォーム送信が完了
- **失敗**: フォームが見つからない、または送信エラー
- **送信不可**: URLが無効、または対応外のサイト

#### リード管理の拡張

- **送信回数**（submit_count）: 同じ企業に送信した回数を記録（再送信可能）
- **最終送信日**（last_submitted_at）: 最後に送信した日時を記録
- **エラーメッセージ**（error_message）: 失敗時の詳細なエラー内容を保存

#### 拡張機能のキュー管理

- 拡張機能のPopupで送信進捗をリアルタイム確認：
  - 待機中: これから処理する件数
  - 処理中: 現在処理中の件数（アイコンが回転）
  - 成功: 送信成功した件数
  - 失敗: 送信失敗した件数
- 「キューと失敗ログを削除」ボタンで成功・失敗のログを削除可能（送信中は無効化）。

#### フロントエンドとの連携

- フロントエンドは拡張機能のステータスを2秒ごとにポーリング。
- すべてのキューが完了（待機=0、処理中=0）した後、自動的にリード表を更新。
- 途中で送信を追加した場合も、すべて完了してから一括更新。

---

## 3. 画面B: 管理ダッシュボード (`/dashboard`)

### 3.1 KPI とグラフ

- Supabase DB の閲覧ログを集計し、以下をカード型 KPI として表示:
  - 総閲覧数 / ユニーク閲覧者
  - PDF 別閲覧回数ランキング
  - 相手企業別の反応率
  - 直近 7 日 / 30 日の閲覧推移
- Recharts などで棒グラフ/折れ線/ヒートマップを表示し、非技術者でも理解できるラベル・ツールチップ・凡例を付ける。

### 3.2 フィルタ・テーブル

- 期間（7日/30日/カスタム）、PDF、企業、担当者でフィルタリング可能にする。
- 閲覧ログテーブルでは `viewer_email`, `company_name`, `pdf_title`, `viewed_at`, `view_count` を表示し、ソート/検索/ページネーションを提供。
- チェックボックス ON の企業だけを抽出するフィルタも用意し、送信対象の成果を追いやすくする。

### 3.3 PDF 管理

- PDF のアップロード/削除/リネームは AI 画面と共通のコンポーネントを利用。Storage との整合性とダッシュボードの統計を同期させる。
- 各 PDF ごとにユニークトークンの発行数・閲覧数・クリック率を一覧表示。

---

## 4. PDF 閲覧ページ (`/pdf/[token]`)

- トラッキング URL が参照されたら、メールアドレス入力フォームを表示し、送信後に PDF を埋め込む。
- メールアドレスと紐づく企業カード・PDF・閲覧時刻を Supabase に保存し、ダッシュボードへリアルタイム（SSE or ポーリング）で反映。
- 未入力/無効トークン時は閲覧させず、エラーメッセージを表示。トークンの有効期限や失効操作も DB で管理する。

---

## 5. Supabase リソース

### テーブル構成

- `lead_lists`: リード（送信先企業）情報
  - `id`, `company_id`, `company_name`, `homepage_url`
  - `contact_name`, `department`, `title`, `email`
  - `send_status`: 送信ステータス（pending/success/failed/blocked）
  - `submit_count`: 送信回数（再送信するたびにインクリメント）
  - `last_submitted_at`: 最終送信日時
  - `error_message`: 失敗時のエラーメッセージ
  - `is_appointed`: アポ獲得フラグ
  - `is_ng`: NG企業フラグ
  - `import_file_name`: インポート元ファイル名
  - `created_at`, `updated_at`

- `pdf_files`: PDF資料管理（Storage パス・サイズ・アップロード者）
- `pdf_send_logs`: PDF送信ログ（送信先企業・送信日時）
- `pdf_open_events`: PDF開封イベント（開封日時・IPアドレス等）

### Chrome拡張機能の設定

- 環境変数 `NEXT_PUBLIC_CHROME_EXTENSION_ID`: 拡張機能のID（公開後は全ユーザー共通）
- 拡張機能は `externally_connectable` で本番URLからの接続を許可
- 拡張機能 → アプリ間の通信でキューの追加、ステータス取得、並行数設定を実行

### 必要な権限

- RLS / サービスロール権限を整理し、AI 画面/ダッシュボードから安全に読み書きできるようにする。

---

## 6. 検証観点

### 基本機能

- Excel で 101 行以上や 5 列目欠損時に読み込みが拒否される。
- Excel 取込完了直後に AI 生成が順次開始し、カードにステータスが表示される。
- 生成テキストで sender / recipient が混在しないこと、`◯◯◯` の補完が必要箇所みに入ること。
- PDF トラッキング URL をクリックした閲覧だけが記録され、ダッシュボードで即時確認できる。

### Chrome拡張機能

- Chrome拡張機能が正しくインストールされ、アプリと接続できること。
- 並行タブ数（1-5）を変更でき、設定値が拡張機能に正しく反映されること。
- 並行数に応じて、複数のブラウザタブが同時に開いてフォーム送信を実行すること。
- 送信中は並行数の変更とログ削除が無効化されること。

### フォーム送信

- 企業のホームページURLから自動的に問い合わせフォームを検出できること。
- フォームに正しく入力され、送信ボタンをクリックできること。
- 送信完了ページ（thanksページ等）を正しく検出できること。
- メールアドレス確認用フィールド、ふりがなフィールド、必須チェックボックスが正しく処理されること。

### 送信結果の管理

- すべてのキューが完了した後、リード表に結果が自動反映されること。
- 送信ステータス（未送信/成功/失敗/送信不可）が正しく記録されること。
- 送信回数が正しくインクリメントされること。
- 最終送信日が送信のたびに更新されること。
- 失敗時のエラーメッセージが保存され、確認できること。
- 失敗した企業も再送信可能であること（スキップされない）。

### UI/UX

- 管理ダッシュボードのフィルタ・グラフが想定通りに反応し、非技術者にも理解しやすい UI になっていること。
- 送信結果列のフィルタリングで「未送信」「成功」「失敗」「送信不可」が正しく動作すること。
- 拡張機能Popupの削除確認がモーダルダイアログで表示されること。
